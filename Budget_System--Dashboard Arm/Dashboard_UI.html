<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Keswick Budget Dashboard</title>
    
    <!-- Google Fonts removed - using system fonts (Lucida Bright, Palatino) -->
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    
    <style>
        /* ============================================================================ */
        /* CSS VARIABLES & RESET */
        /* ============================================================================ */
        
        :root {
            --primary-color: #13381f;
            --primary-dark: #0f2817;
            --primary-light: #4caf50;
            --secondary-color: #ff9800;
            --danger-color: #f44336;
            --warning-color: #ff9800;
            --success-color: #4caf50;
            --info-color: #2196f3;
            
            --text-primary: #212121;
            --text-secondary: #757575;
            --text-light: #9e9e9e;
            
            --bg-primary: #ffffff;
            --bg-secondary: #f5f5f5;
            --bg-tertiary: #e0e0e0;
            
            --border-color: #e0e0e0;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.12);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 20px rgba(0,0,0,0.15);
            
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
            
            --transition-fast: 150ms ease;
            --transition-normal: 300ms ease;
        }

        /* ============================================================================ */
        /* HEADER TYPOGRAPHY - Lucida Bright Demi Style */
        /* ============================================================================ */

        h1, h2, h3, .page-title, .chart-title, .table-title,
        .dashboard-title-text .main-word {
            font-family: 'Lucida Bright', 'Lucida Serif', Georgia, serif;
            font-weight: 600;
            color: #13381f;
        }

        h1, .page-title { font-size: 24pt; }
        h2, .chart-title, .table-title { font-size: 18pt; }
        h3 { font-size: 14pt; }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Palatino Linotype', Palatino, 'Book Antiqua', Georgia, serif;
            font-size: 10pt;
            line-height: 1.6;
            color: var(--text-primary);
            background-color: var(--bg-secondary);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* ============================================================================ */
        /* DEBUG CONSOLE STYLES */
        /* ============================================================================ */
        
        .debug-console {
            position: fixed;
            right: 20px;
            top: 20px;
            width: 600px;
            max-width: 90vw;
            height: 500px;
            max-height: 80vh;
            background: #1a1a1a;
            color: #f0f0f0;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            z-index: 10000;
            display: flex;
            flex-direction: column;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 12px;
        }
        
        .debug-console.hidden {
            display: none;
        }
        
        .debug-header {
            background: #2a2a2a;
            padding: 12px 16px;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #3a3a3a;
        }
        
        .debug-title {
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .debug-stats {
            font-size: 11px;
            color: #888;
            font-weight: normal;
            margin-left: 16px;
        }
        
        .debug-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .debug-filter {
            background: #1a1a1a;
            color: #f0f0f0;
            border: 1px solid #3a3a3a;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
        }
        
        .debug-btn {
            background: #3a3a3a;
            color: #f0f0f0;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            transition: background 0.2s;
        }
        
        .debug-btn:hover {
            background: #4a4a4a;
        }
        
        .debug-btn.primary {
            background: #1b5e20;
            color: white;
        }
        
        .debug-btn.primary:hover {
            background: #2e7d32;
        }
        
        .debug-body {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .debug-logs {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            background: #0a0a0a;
        }
        
        .debug-log-entry {
            margin-bottom: 8px;
            padding: 8px;
            border-radius: 4px;
            background: #1a1a1a;
            border-left: 3px solid #3a3a3a;
            transition: all 0.2s;
        }
        
        .debug-log-entry:hover {
            background: #2a2a2a;
        }
        
        .debug-log-entry.debug {
            border-left-color: #64b5f6;
        }
        
        .debug-log-entry.info {
            border-left-color: #81c784;
        }
        
        .debug-log-entry.warn {
            border-left-color: #ffb74d;
        }
        
        .debug-log-entry.error {
            border-left-color: #e57373;
            background: #2a1a1a;
        }
        
        .debug-log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }
        
        .debug-log-level {
            font-weight: 600;
            text-transform: uppercase;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 3px;
            background: #2a2a2a;
        }
        
        .debug-log-level.debug { color: #64b5f6; }
        .debug-log-level.info { color: #81c784; }
        .debug-log-level.warn { color: #ffb74d; }
        .debug-log-level.error { color: #e57373; }
        
        .debug-log-meta {
            color: #666;
            font-size: 10px;
        }
        
        .debug-log-message {
            color: #f0f0f0;
            margin-bottom: 4px;
        }
        
        .debug-log-data {
            background: #0a0a0a;
            padding: 6px;
            border-radius: 3px;
            font-size: 11px;
            color: #888;
            white-space: pre-wrap;
            word-break: break-all;
        }
        
        .debug-footer {
            padding: 12px 16px;
            border-top: 1px solid #3a3a3a;
            background: #2a2a2a;
        }
        
        .debug-actions {
            display: flex;
            gap: 8px;
        }
        
        /* Debug Toggle Button */
        .debug-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #1b5e20;
            color: white;
            border: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            z-index: 9999;
            transition: all 0.3s;
            font-size: 20px;
        }
        
        .debug-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
        }
        
        .debug-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #f44336;
            color: white;
            font-size: 10px;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 20px;
            text-align: center;
        }
        
        .debug-badge.hidden {
            display: none;
        }
        
        /* ============================================================================ */
        /* LAYOUT COMPONENTS */
        /* ============================================================================ */

        /* Unified Top Header - spans full width */
        .unified-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 24px;
            background: var(--bg-primary);
            border-bottom: 2px solid var(--primary-color);
            gap: 24px;
        }

        .unified-header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .unified-header-logo img {
            height: 45px;
            width: auto;
        }

        .logo-text-fallback {
            font-family: 'Lucida Bright', Georgia, serif;
            font-weight: 600;
            font-size: 18px;
            color: #13381f;
        }

        .unified-header-title {
            font-size: 22pt;
            font-weight: 600;
            color: #13381f;
            margin: 0;
            margin-left: 20px;
        }

        .unified-header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .dashboard-container {
            display: flex;
            min-height: calc(100vh - 70px); /* Account for unified header */
        }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background: var(--bg-primary);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            transition: margin-left var(--transition-normal);
        }

        .sidebar.collapsed {
            margin-left: -260px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            text-decoration: none;
            color: var(--text-primary);
        }
        
        .logo img {
            height: 40px;
            width: auto;
        }
        
        .logo-text {
            font-size: 18px;
            font-weight: 600;
            line-height: 1.2;
        }
        
        .nav-menu {
            flex: 1;
            padding: 16px 0;
            overflow-y: auto;
        }
        
        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 24px;
            color: var(--text-secondary);
            text-decoration: none;
            transition: all var(--transition-fast);
            cursor: pointer;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-size: 14px;
        }
        
        .nav-item:hover {
            color: var(--primary-color);
            background-color: rgba(19, 56, 31, 0.05);
        }
        
        .nav-item.active {
            color: var(--primary-color);
            background-color: rgba(19, 56, 31, 0.1);
            font-weight: 500;
            position: relative;
        }
        
        .nav-item.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background-color: var(--primary-color);
        }
        
        .nav-icon {
            width: 20px;
            text-align: center;
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }
        
        /* ============================================================================ */
        /* HEADER - Institutional Design */
        /* ============================================================================ */

        .header {
            background: var(--bg-primary);
            border-bottom: 2px solid var(--primary-color);
            padding: 24px 32px 16px;
        }

        /* Institutional header - 3-column grid like PO */
        .header-institutional {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            align-items: center;
            column-gap: 40px;
            margin-bottom: 16px;
        }

        .school-name-img {
            display: flex;
            justify-content: flex-start;
            align-items: center;
        }

        .shield-crest {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-shrink: 0;
        }

        .dashboard-title {
            display: flex;
            justify-content: flex-end;
            align-items: center;
        }

        .dashboard-title-text .main-word {
            font-family: 'Lucida Bright', 'Lucida Serif', Georgia, serif;
            font-size: 32pt;
            font-weight: 600;
            color: #13381f;
            line-height: 1.1;
            letter-spacing: 0.8px;
        }

        /* Actions row below institutional header */
        .header-actions {
            display: flex;
            align-items: center;
            gap: 16px;
            padding-top: 12px;
            border-top: 1px solid var(--border-color);
        }

        .header-spacer {
            flex: 1;
        }

        .page-subtitle {
            font-size: 16pt;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .menu-toggle {
            display: none;
            background: none;
            border: none;
            font-size: 20px;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 8px;
            border-radius: var(--radius-sm);
            transition: all var(--transition-fast);
        }

        .menu-toggle:hover {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
        }

        .header-button {
            background: none;
            border: 1px solid var(--border-color);
            padding: 8px 16px;
            border-radius: var(--radius-md);
            font-size: 14px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header-button:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
            background-color: rgba(19, 56, 31, 0.05);
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 16px;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: background-color var(--transition-fast);
        }

        .user-menu:hover {
            background-color: var(--bg-secondary);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
            font-size: 14px;
        }

        .user-info {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .user-name {
            font-weight: 500;
            color: var(--text-primary);
            font-size: 14px;
        }

        .user-role {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        /* Content Area */
        .content {
            flex: 1;
            padding: 32px;
            overflow-y: auto;
        }
        
        /* ============================================================================ */
        /* LOADING STATES */
        /* ============================================================================ */
        
        .loading-container {
            position: fixed;
            inset: 0;
            background-color: rgba(255, 255, 255, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            backdrop-filter: blur(4px);
        }
        
        .loading-content {
            text-align: center;
            max-width: 400px;
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--bg-tertiary);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 24px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-text {
            font-size: 18px;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 8px;
        }
        
        .loading-subtext {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 24px;
        }
        
        .loading-progress {
            width: 100%;
            height: 4px;
            background-color: var(--bg-tertiary);
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 12px;
        }
        
        .loading-progress-bar {
            height: 100%;
            background-color: var(--primary-color);
            width: 0%;
            transition: width 300ms ease;
            animation: progress 2s ease-in-out infinite;
        }
        
        @keyframes progress {
            0% { width: 0%; }
            50% { width: 70%; }
            100% { width: 100%; }
        }
        
        .loading-error {
            background-color: #ffebee;
            border: 1px solid #ffcdd2;
            border-radius: var(--radius-md);
            padding: 16px;
            margin-top: 24px;
        }
        
        .loading-error-title {
            color: #c62828;
            font-weight: 500;
            margin-bottom: 8px;
        }
        
        .loading-error-message {
            color: #d32f2f;
            font-size: 14px;
            margin-bottom: 16px;
        }
        
        .loading-error-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
        }
        
        .error-button {
            padding: 8px 16px;
            border-radius: var(--radius-sm);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-fast);
            border: none;
        }
        
        .error-button.primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .error-button.primary:hover {
            background-color: var(--primary-dark);
        }
        
        .error-button.secondary {
            background-color: transparent;
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
        }
        
        .error-button.secondary:hover {
            background-color: rgba(19, 56, 31, 0.05);
        }
        
        /* Error Alert */
        .error-alert {
            background-color: #ffebee;
            border: 1px solid #ffcdd2;
            border-radius: var(--radius-md);
            padding: 16px;
            margin-bottom: 24px;
            display: flex;
            align-items: start;
            gap: 12px;
        }
        
        .error-icon {
            color: #f44336;
            font-size: 20px;
            flex-shrink: 0;
        }
        
        .error-content {
            flex: 1;
        }
        
        .error-title {
            font-weight: 500;
            color: #c62828;
            margin-bottom: 4px;
        }
        
        .error-message {
            color: #d32f2f;
            font-size: 14px;
        }
        
        /* ============================================================================ */
        /* CARDS & WIDGETS */
        /* ============================================================================ */
        
        .widget-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }
        
        .widget-card {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 24px;
            transition: all var(--transition-normal);
        }
        
        .widget-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }
        
        .widget-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }
        
        .widget-title {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .widget-icon {
            font-size: 20px;
            color: var(--text-light);
        }
        
        .widget-value {
            font-size: 32px;
            font-weight: 600;
            color: var(--text-primary);
            line-height: 1.2;
            margin-bottom: 8px;
        }
        
        .widget-subtitle {
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        .widget-trend {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
            font-weight: 500;
            padding: 4px 8px;
            border-radius: var(--radius-sm);
            margin-top: 12px;
        }
        
        .widget-trend.up {
            color: var(--success-color);
            background-color: rgba(76, 175, 80, 0.1);
        }
        
        .widget-trend.down {
            color: var(--danger-color);
            background-color: rgba(244, 67, 54, 0.1);
        }
        
        /* Charts */
        .chart-container {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 24px;
            margin-bottom: 24px;
        }
        
        .chart-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
        }
        
        .chart-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .chart-actions {
            display: flex;
            gap: 8px;
        }
        
        .chart-canvas {
            max-height: 400px;
        }
        
        /* Tables */
        .table-container {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            overflow: hidden;
            margin-bottom: 24px;
        }
        
        .table-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .table-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .table-wrapper {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            text-align: left;
            padding: 12px 24px;
            font-weight: 500;
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background-color: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            white-space: nowrap;
        }
        
        td {
            padding: 16px 24px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
        }
        
        tr:last-child td {
            border-bottom: none;
        }
        
        tr:hover {
            background-color: rgba(0, 0, 0, 0.02);
        }
        
        /* Status Badges */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            text-transform: capitalize;
        }
        
        .status-badge.approved {
            background-color: rgba(76, 175, 80, 0.1);
            color: var(--success-color);
        }
        
        .status-badge.pending {
            background-color: rgba(255, 152, 0, 0.1);
            color: var(--warning-color);
        }
        
        .status-badge.rejected {
            background-color: rgba(244, 67, 54, 0.1);
            color: var(--danger-color);
        }

        .status-badge.processing {
            background-color: rgba(33, 150, 243, 0.1);
            color: #1976D2;
        }

        /* Sortable Tables */
        .sortable-table th.sortable {
            cursor: pointer;
            user-select: none;
            position: relative;
            padding-right: 24px;
        }

        .sortable-table th.sortable:hover {
            background-color: rgba(19, 56, 31, 0.05);
        }

        .sortable-table th.sortable .sort-icon::after {
            content: '';
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0.3;
        }

        .sortable-table th.sortable.sort-asc .sort-icon::after {
            content: '\25B2';
            opacity: 1;
            color: var(--primary-color);
        }

        .sortable-table th.sortable.sort-desc .sort-icon::after {
            content: '\25BC';
            opacity: 1;
            color: var(--primary-color);
        }

        /* Table Filters */
        .table-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            align-items: flex-end;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .table-filters .filter-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .table-filters .filter-group label {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .table-filters select,
        .table-filters input[type="date"] {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
            background: white;
            min-width: 140px;
        }

        .table-filters select:focus,
        .table-filters input[type="date"]:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(19, 56, 31, 0.1);
        }

        .filter-clear-btn {
            padding: 8px 16px;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .filter-clear-btn:hover {
            background: var(--primary-light);
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        .filter-count {
            font-size: 13px;
            color: var(--text-secondary);
            margin-left: auto;
            padding: 8px 0;
        }

        /* Tabs */
        .tabs-container {
            margin-bottom: 32px;
        }
        
        .tabs-header {
            display: flex;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 24px;
        }
        
        .tab-button {
            padding: 12px 24px;
            background: none;
            border: none;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            position: relative;
            transition: all var(--transition-fast);
        }
        
        .tab-button:hover {
            color: var(--text-primary);
        }
        
        .tab-button.active {
            color: var(--primary-color);
        }
        
        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background-color: var(--primary-color);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn var(--transition-normal);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Responsive */
        @media (max-width: 1024px) {
            .menu-toggle {
                display: block;
            }

            /* Institutional header responsive - stack vertically */
            .header-institutional {
                grid-template-columns: 1fr;
                row-gap: 16px;
            }

            .school-name-img,
            .shield-crest,
            .dashboard-title {
                justify-content: center;
            }

            .dashboard-title-text .main-word {
                text-align: center;
            }

            .sidebar {
                position: fixed;
                top: 0;
                left: 0;
                height: 100vh;
                z-index: 1000;
                box-shadow: var(--shadow-lg);
            }

            .sidebar.collapsed {
                margin-left: -260px;
            }

            .content {
                padding: 24px;
            }

            .debug-console {
                right: 10px;
                top: 10px;
                width: calc(100vw - 20px);
                height: calc(100vh - 100px);
            }
        }

        @media (max-width: 768px) {
            /* Unified header responsive */
            .unified-header {
                padding: 10px 16px;
                flex-wrap: wrap;
                gap: 12px;
            }

            .unified-header-title {
                font-size: 16pt;
            }

            .unified-header-logo img {
                height: 35px;
            }

            .unified-header-right .header-button span {
                display: none;
            }

            /* Smaller header images on mobile */
            .dashboard-title-text .main-word {
                font-size: 24pt;
            }

            .school-name-img img {
                height: 60px;
            }

            .shield-crest img {
                height: 75px;
            }

            .widget-grid {
                grid-template-columns: 1fr;
            }

            .content {
                padding: 16px;
            }

            .page-title {
                font-size: 20px;
            }
        }
        
        /* ============================================================================ */
        /* UTILITY CLASSES */
        /* ============================================================================ */
        
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .text-muted { color: var(--text-secondary); }
        .text-danger { color: var(--danger-color); }
        .text-success { color: var(--success-color); }
        .text-warning { color: var(--warning-color); }
        
        .mt-1 { margin-top: 8px; }
        .mt-2 { margin-top: 16px; }
        .mt-3 { margin-top: 24px; }
        .mt-4 { margin-top: 32px; }
        
        .mb-1 { margin-bottom: 8px; }
        .mb-2 { margin-bottom: 16px; }
        .mb-3 { margin-bottom: 24px; }
        .mb-4 { margin-bottom: 32px; }
        
        .hidden { display: none !important; }
        
        /* ============================================================================ */
        /* DATA MODE BANNER (DEMO / LIVE) */
        /* ============================================================================ */

        .data-mode-banner {
            padding: 10px 24px;
            text-align: center;
            font-size: 13px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
        }

        .data-mode-banner.demo-mode {
            background-color: #fff3e0;
            border-bottom: 2px solid #ff9800;
            color: #e65100;
        }

        .data-mode-banner.live-mode {
            background-color: #e8f5e9;
            border-bottom: 2px solid #4caf50;
            color: #2e7d32;
        }

        .data-mode-banner strong {
            font-weight: 600;
        }

        .data-mode-banner .mode-icon {
            font-size: 16px;
        }

        .data-mode-banner .toggle-btn {
            padding: 4px 12px;
            border-radius: 4px;
            border: 1px solid currentColor;
            background: transparent;
            color: inherit;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .data-mode-banner .toggle-btn:hover {
            background: rgba(0,0,0,0.1);
        }

        .data-mode-banner.demo-mode .toggle-btn {
            border-color: #e65100;
        }

        .data-mode-banner.live-mode .toggle-btn {
            border-color: #2e7d32;
        }

        /* Role Switcher Styles */
        .role-switcher-container {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: 16px;
            padding-left: 16px;
            border-left: 1px solid rgba(0,0,0,0.2);
        }

        .role-switcher-container.hidden {
            display: none;
        }

        .role-switcher-label {
            font-size: 12px;
            font-weight: 500;
            color: inherit;
            white-space: nowrap;
        }

        .role-switcher-select {
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid currentColor;
            background: white;
            font-size: 12px;
            cursor: pointer;
            min-width: 110px;
            color: #333;
        }

        .role-switcher-select:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(230, 81, 0, 0.3);
        }

        .role-switcher-select.hidden {
            display: none;
        }

        /* Legacy demo-banner class for compatibility */
        .demo-banner {
            background-color: #fff3e0;
            border: 1px solid #ffe0b2;
            padding: 12px 24px;
            text-align: center;
            font-size: 14px;
            color: #e65100;
        }

        .demo-banner strong {
            font-weight: 600;
        }
        
    </style>
</head>
<body>
    <!-- Loading State -->
    <div id="loadingContainer" class="loading-container">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text">Loading Keswick Budget Dashboard</div>
            <div class="loading-subtext">Authenticating and fetching your data...</div>
            <div class="loading-progress">
                <div class="loading-progress-bar"></div>
            </div>
            <div id="loadingStatus" class="text-muted" style="font-size: 12px; margin-top: 8px;">
                Initializing...
            </div>
            <div id="loadingError" class="loading-error hidden">
                <div class="loading-error-title">Connection Issue</div>
                <div class="loading-error-message">
                    Unable to connect to the dashboard. This might be a temporary issue.
                </div>
                <div class="loading-error-actions">
                    <button class="error-button primary" onclick="retryConnection()">
                        <i class="fas fa-redo"></i> Retry
                    </button>
                    <button class="error-button secondary" onclick="loadDemoMode()">
                        <i class="fas fa-play"></i> Demo Mode
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main Dashboard -->
    <div id="dashboardContainer" class="hidden">
        <!-- Unified Top Header -->
        <header class="unified-header">
            <div class="unified-header-left">
                <button id="menuToggle" class="menu-toggle">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="unified-header-logo">
                    <img id="sidebarLogo" src="" alt="Keswick Christian School" style="display:none;" onerror="this.style.display='none';" onload="this.style.display='block';" />
                    <span id="sidebarLogoText" class="logo-text-fallback">Keswick</span>
                </div>
                <h1 id="pageTitle" class="unified-header-title">Budget Dashboard</h1>
            </div>
            <div class="unified-header-right">
                <button class="header-button" onclick="refreshDashboard()">
                    <i class="fas fa-sync-alt"></i>
                    <span>Refresh</span>
                </button>
                <button class="header-button" onclick="exportDashboard()">
                    <i class="fas fa-download"></i>
                    <span>Export</span>
                </button>
                <div class="user-menu" id="userMenu">
                    <div class="user-avatar" id="userAvatar">
                        <span id="userInitials">JD</span>
                    </div>
                    <div class="user-info">
                        <div id="userName" class="user-name">John Doe</div>
                        <div id="userRole" class="user-role">Executive</div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Content Area (Sidebar + Main) -->
        <div class="dashboard-container">
            <!-- Sidebar -->
            <aside id="sidebar" class="sidebar">
                <nav class="nav-menu">
                <button class="nav-item active" data-tab="overview">
                    <i class="fas fa-chart-line nav-icon"></i>
                    <span>Overview</span>
                </button>
                <button class="nav-item" data-tab="transactions">
                    <i class="fas fa-receipt nav-icon"></i>
                    <span>Transactions</span>
                </button>
                <button class="nav-item" data-tab="tac">
                    <i class="fas fa-calculator nav-icon"></i>
                    <span>TAC Calculator</span>
                </button>
                <button class="nav-item" data-tab="reports">
                    <i class="fas fa-file-alt nav-icon"></i>
                    <span>Reports</span>
                </button>
                <button class="nav-item" data-tab="analytics">
                    <i class="fas fa-chart-pie nav-icon"></i>
                    <span>Analytics</span>
                </button>
            </nav>
        </aside>
        
        <!-- Main Content -->
        <main class="main-content">
            <!-- Hidden elements for image loading compatibility -->
            <img id="schoolNameLogo" src="" alt="" style="display: none;" />
            <img id="schoolCrest" src="" alt="" style="display: none;" />

            <!-- Data Mode Banner (Demo/Live) -->
            <div id="dataModeBanner" class="data-mode-banner demo-mode hidden">
                <i class="fas fa-info-circle mode-icon"></i>
                <span id="dataModeMessage">
                    <strong>Demo Mode:</strong> You're viewing sample data.
                </span>

                <!-- Role Switcher (only visible in demo mode) -->
                <div id="roleSwitcherContainer" class="role-switcher-container hidden">
                    <label class="role-switcher-label">View as:</label>
                    <select id="roleSelect" class="role-switcher-select" onchange="onRoleChange(this.value)">
                        <option value="executive">Executive</option>
                        <option value="principal">Principal</option>
                        <option value="department_head">Department Head</option>
                    </select>

                    <select id="divisionSelect" class="role-switcher-select hidden" onchange="onDivisionChange(this.value)">
                        <option value="">Select Division...</option>
                    </select>

                    <select id="departmentSelect" class="role-switcher-select hidden" onchange="onDepartmentChange(this.value)">
                        <option value="">Select Department...</option>
                    </select>
                </div>

                <button id="toggleModeBtn" class="toggle-btn hidden" onclick="toggleDataMode()">
                    <i class="fas fa-exchange-alt"></i> Switch to Live
                </button>
            </div>

            <!-- Legacy demo banner for backward compatibility -->
            <div id="demoBanner" class="demo-banner hidden">
                <i class="fas fa-info-circle"></i>
                <strong>Demo Mode:</strong> You're viewing sample data. Some features may be limited.
            </div>
            
            <!-- Content Area -->
            <div class="content">
                <!-- Error Alert -->
                <div id="errorAlert" class="error-alert hidden">
                    <i class="fas fa-exclamation-triangle error-icon"></i>
                    <div class="error-content">
                        <div class="error-title">Unable to load some data</div>
                        <div class="error-message">
                            Some dashboard components couldn't be loaded. You can continue working with cached data.
                        </div>
                    </div>
                </div>
                
                <!-- Tab Contents -->
                <div id="overviewTab" class="tab-content active">
                    <!-- KPI Widgets -->
                    <div id="kpiGrid" class="widget-grid">
                        <!-- KPIs will be inserted here -->
                    </div>
                    
                    <!-- Charts -->
                    <div class="chart-container">
                        <div class="chart-header">
                            <h2 class="chart-title">Budget Overview by Division</h2>
                            <div class="chart-actions">
                                <button class="header-button" onclick="toggleChartType()">
                                    <i class="fas fa-chart-bar"></i>
                                </button>
                            </div>
                        </div>
                        <canvas id="divisionChart" class="chart-canvas"></canvas>
                    </div>
                    
                    <!-- Division Summary Table -->
                    <div class="table-container">
                        <div class="table-header">
                            <h2 class="table-title">Division Summary</h2>
                        </div>
                        <div class="table-wrapper">
                            <table id="divisionTable" class="sortable-table">
                                <thead>
                                    <tr>
                                        <th class="sortable" data-sort="name" onclick="sortTable('divisionTable', 'name', 'string')">Division <span class="sort-icon"></span></th>
                                        <th class="sortable" data-sort="allocated" onclick="sortTable('divisionTable', 'allocated', 'currency')">Allocated <span class="sort-icon"></span></th>
                                        <th class="sortable" data-sort="spent" onclick="sortTable('divisionTable', 'spent', 'currency')">Spent <span class="sort-icon"></span></th>
                                        <th class="sortable" data-sort="encumbered" onclick="sortTable('divisionTable', 'encumbered', 'currency')">Encumbered <span class="sort-icon"></span></th>
                                        <th class="sortable" data-sort="available" onclick="sortTable('divisionTable', 'available', 'currency')">Available <span class="sort-icon"></span></th>
                                        <th class="sortable" data-sort="utilization" onclick="sortTable('divisionTable', 'utilization', 'number')">Utilization <span class="sort-icon"></span></th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Data will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div id="transactionsTab" class="tab-content">
                    <!-- Transactions content -->
                    <div class="table-container">
                        <div class="table-header">
                            <h2 class="table-title">Recent Transactions</h2>
                        </div>
                        <!-- Transaction Filters -->
                        <div class="table-filters" id="transactionFilters">
                            <div class="filter-group">
                                <label>Division</label>
                                <select id="txnFilterDivision" onchange="applyTransactionFilters()">
                                    <option value="">All Divisions</option>
                                    <option value="US">Upper School</option>
                                    <option value="LS">Lower School</option>
                                    <option value="KK">Keswick Kids</option>
                                    <option value="AD">Administration</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>Status</label>
                                <select id="txnFilterStatus" onchange="applyTransactionFilters()">
                                    <option value="">All Statuses</option>
                                    <option value="Approved">Approved</option>
                                    <option value="Pending">Pending</option>
                                    <option value="Processing">Processing</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>From</label>
                                <input type="date" id="txnFilterDateStart" onchange="applyTransactionFilters()">
                            </div>
                            <div class="filter-group">
                                <label>To</label>
                                <input type="date" id="txnFilterDateEnd" onchange="applyTransactionFilters()">
                            </div>
                            <div class="filter-group">
                                <button class="filter-clear-btn" onclick="clearTransactionFilters()">Clear Filters</button>
                            </div>
                            <div class="filter-count" id="txnFilterCount"></div>
                        </div>
                        <div class="table-wrapper">
                            <table id="transactionsTable" class="sortable-table">
                                <thead>
                                    <tr>
                                        <th class="sortable" data-sort="date" onclick="sortTable('transactionsTable', 'date', 'date')">Date <span class="sort-icon"></span></th>
                                        <th class="sortable" data-sort="id" onclick="sortTable('transactionsTable', 'id', 'string')">ID <span class="sort-icon"></span></th>
                                        <th class="sortable" data-sort="division" onclick="sortTable('transactionsTable', 'division', 'string')">Division <span class="sort-icon"></span></th>
                                        <th class="sortable" data-sort="department" onclick="sortTable('transactionsTable', 'department', 'string')">Department <span class="sort-icon"></span></th>
                                        <th class="sortable" data-sort="vendor" onclick="sortTable('transactionsTable', 'vendor', 'string')">Vendor <span class="sort-icon"></span></th>
                                        <th>Description</th>
                                        <th class="sortable" data-sort="amount" onclick="sortTable('transactionsTable', 'amount', 'currency')">Amount <span class="sort-icon"></span></th>
                                        <th class="sortable" data-sort="status" onclick="sortTable('transactionsTable', 'status', 'string')">Status <span class="sort-icon"></span></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Data will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div id="tacTab" class="tab-content">
                    <!-- TAC Tracker - Grade Level Tracking -->

                    <!-- TAC Summary KPIs -->
                    <div id="tacKpiGrid" class="widget-grid">
                        <!-- TAC KPIs will be inserted here -->
                    </div>

                    <!-- Grade-Level TAC Tracking Table -->
                    <div class="chart-container">
                        <div class="chart-header">
                            <h2 class="chart-title">TAC Tracking by Grade Level</h2>
                            <div class="chart-actions">
                                <select id="tacDivisionFilter" onchange="filterTACByDivision()" style="padding: 6px 12px; border-radius: 4px; border: 1px solid var(--border-color); font-size: 13px;">
                                    <option value="ALL">All Divisions</option>
                                    <option value="KK">Keswick Kids</option>
                                    <option value="LS">Lower School</option>
                                    <option value="MS">Middle School</option>
                                    <option value="US">Upper School</option>
                                </select>
                                <button onclick="exportTACData()" class="btn-secondary" style="margin-left: 8px;">
                                    <i class="fas fa-download"></i> Export
                                </button>
                            </div>
                        </div>
                        <div class="table-wrapper">
                            <table class="data-table" id="tacGradeTable">
                                <thead>
                                    <tr>
                                        <th>Grade</th>
                                        <th>Division</th>
                                        <th>Enrollment</th>
                                        <th>TAC Fee</th>
                                        <th>TAC Budgeted</th>
                                        <th>TAC Spent</th>
                                        <th>Variance</th>
                                        <th>Curricular</th>
                                        <th>Field Trips</th>
                                        <th>Tech Cost</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="tacGradeTableBody">
                                    <!-- 17 grade rows will be inserted here -->
                                </tbody>
                                <tfoot id="tacGradeTableFooter">
                                    <!-- Totals row -->
                                </tfoot>
                            </table>
                        </div>
                    </div>

                    <!-- Enrollment Editor (Collapsible) -->
                    <div class="chart-container">
                        <div class="chart-header" style="cursor: pointer;" onclick="toggleEnrollmentEditor()">
                            <h2 class="chart-title">
                                <i class="fas fa-edit" style="margin-right: 8px;"></i>
                                Edit Enrollment Numbers
                                <i id="enrollmentToggleIcon" class="fas fa-chevron-down" style="margin-left: 8px; font-size: 12px;"></i>
                            </h2>
                            <p style="color: var(--text-secondary); font-size: 12px; margin-top: 4px;">Click to expand and update student counts per grade</p>
                        </div>
                        <div id="enrollmentEditor" style="display: none; padding: 16px;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 12px; margin-bottom: 16px;">
                                <!-- Enrollment inputs will be generated dynamically -->
                            </div>
                            <div style="display: flex; gap: 12px; margin-top: 16px;">
                                <button onclick="saveTACEnrollment()" class="btn-primary">
                                    <i class="fas fa-save"></i> Save Enrollment
                                </button>
                                <button onclick="resetEnrollmentToDefaults()" class="btn-secondary">
                                    <i class="fas fa-undo"></i> Reset to Defaults
                                </button>
                            </div>
                            <div id="enrollmentSaveStatus" style="margin-top: 12px; display: none;"></div>
                        </div>
                    </div>

                    <!-- Step Up Payment Tracker -->
                    <div class="chart-container">
                        <div class="chart-header">
                            <h2 class="chart-title">FL Step Up Payment Tracker</h2>
                            <p style="color: var(--text-secondary); font-size: 12px; margin-top: 4px;">Quarterly scholarship payments from Florida Step Up for Students</p>
                        </div>
                        <div style="padding: 16px;">
                            <div id="stepUpSummary" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-bottom: 20px;">
                                <!-- Step Up KPIs -->
                            </div>
                            <div id="stepUpQuarters" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px;">
                                <!-- Quarterly progress bars -->
                            </div>
                        </div>
                    </div>

                    <!-- TAC Category Summary (Compact) -->
                    <div class="chart-container">
                        <div class="chart-header">
                            <h2 class="chart-title">TAC Expenses by Category</h2>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; padding: 16px;">
                            <div>
                                <canvas id="tacCategoryChart" height="200"></canvas>
                            </div>
                            <div id="tacCategoryBreakdown">
                                <!-- Category breakdown cards -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="reportsTab" class="tab-content">
                    <!-- Reports content -->
                    <!-- Report Selection -->
                    <div class="chart-container">
                        <div class="chart-header">
                            <h2 class="chart-title">Generate Reports</h2>
                            <p style="color: var(--text-secondary); font-size: 12px; margin-top: 4px;">Select a report type and configure options</p>
                        </div>
                        <div style="padding: 16px;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px;">
                                <!-- Budget Summary Report -->
                                <div class="report-card" style="border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; cursor: pointer; transition: all 0.2s;" onclick="generateReport('budget')">
                                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                                        <div style="width: 48px; height: 48px; background: rgba(19, 56, 31, 0.1); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                            <i class="fas fa-chart-bar" style="font-size: 24px; color: var(--primary-green);"></i>
                                        </div>
                                        <div>
                                            <h3 style="font-size: 16px; font-weight: 600; margin: 0;">Budget Summary</h3>
                                            <p style="font-size: 12px; color: var(--text-secondary); margin: 0;">Division & department overview</p>
                                        </div>
                                    </div>
                                    <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 12px;">Comprehensive budget status report showing allocations, spending, and utilization rates by division and department.</p>
                                    <button class="header-button" style="width: 100%;">
                                        <i class="fas fa-download"></i> Generate Report
                                    </button>
                                </div>

                                <!-- Transaction Report -->
                                <div class="report-card" style="border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; cursor: pointer; transition: all 0.2s;" onclick="generateReport('transactions')">
                                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                                        <div style="width: 48px; height: 48px; background: rgba(19, 56, 31, 0.1); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                            <i class="fas fa-list-alt" style="font-size: 24px; color: var(--primary-green);"></i>
                                        </div>
                                        <div>
                                            <h3 style="font-size: 16px; font-weight: 600; margin: 0;">Transaction Report</h3>
                                            <p style="font-size: 12px; color: var(--text-secondary); margin: 0;">Detailed transaction history</p>
                                        </div>
                                    </div>
                                    <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 12px;">Export all transactions with date range filtering. Includes vendor, amount, status, and approval details.</p>
                                    <button class="header-button" style="width: 100%;">
                                        <i class="fas fa-download"></i> Generate Report
                                    </button>
                                </div>

                                <!-- TAC Report -->
                                <div class="report-card" style="border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; cursor: pointer; transition: all 0.2s;" onclick="generateReport('tac')">
                                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                                        <div style="width: 48px; height: 48px; background: rgba(19, 56, 31, 0.1); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                            <i class="fas fa-calculator" style="font-size: 24px; color: var(--primary-green);"></i>
                                        </div>
                                        <div>
                                            <h3 style="font-size: 16px; font-weight: 600; margin: 0;">TAC Report</h3>
                                            <p style="font-size: 12px; color: var(--text-secondary); margin: 0;">Technology, Activities, Curriculum</p>
                                        </div>
                                    </div>
                                    <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 12px;">TAC fee collection and expense report by category. Shows cost per student analysis and budget utilization.</p>
                                    <button class="header-button" style="width: 100%;">
                                        <i class="fas fa-download"></i> Generate Report
                                    </button>
                                </div>

                                <!-- Admin Expenses Report (NEW) -->
                                <div class="report-card" style="border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; cursor: pointer; transition: all 0.2s;" onclick="generateReport('admin')">
                                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                                        <div style="width: 48px; height: 48px; background: rgba(19, 56, 31, 0.1); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                            <i class="fas fa-building" style="font-size: 24px; color: var(--primary-green);"></i>
                                        </div>
                                        <div>
                                            <h3 style="font-size: 16px; font-weight: 600; margin: 0;">Admin Expenses</h3>
                                            <p style="font-size: 12px; color: var(--text-secondary); margin: 0;">Administrative costs breakdown</p>
                                        </div>
                                    </div>
                                    <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 12px;">Administrative expenses grouped by department. Includes office supplies, professional services, and operational costs.</p>
                                    <button class="header-button" style="width: 100%;">
                                        <i class="fas fa-download"></i> Generate Report
                                    </button>
                                </div>

                                <!-- Curriculum Report (NEW) -->
                                <div class="report-card" style="border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; cursor: pointer; transition: all 0.2s;" onclick="generateReport('curriculum')">
                                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                                        <div style="width: 48px; height: 48px; background: rgba(19, 56, 31, 0.1); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                            <i class="fas fa-book-open" style="font-size: 24px; color: var(--primary-green);"></i>
                                        </div>
                                        <div>
                                            <h3 style="font-size: 16px; font-weight: 600; margin: 0;">Curriculum Report</h3>
                                            <p style="font-size: 12px; color: var(--text-secondary); margin: 0;">By subject/grade level</p>
                                        </div>
                                    </div>
                                    <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 12px;">Curriculum spending by department: subject areas for Upper School, grade levels for Lower School.</p>
                                    <button class="header-button" style="width: 100%;">
                                        <i class="fas fa-download"></i> Generate Report
                                    </button>
                                </div>

                                <!-- Field Trip Report (NEW) -->
                                <div class="report-card" style="border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; cursor: pointer; transition: all 0.2s;" onclick="generateReport('fieldtrip')">
                                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                                        <div style="width: 48px; height: 48px; background: rgba(19, 56, 31, 0.1); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                            <i class="fas fa-bus" style="font-size: 24px; color: var(--primary-green);"></i>
                                        </div>
                                        <div>
                                            <h3 style="font-size: 16px; font-weight: 600; margin: 0;">Field Trip Report</h3>
                                            <p style="font-size: 12px; color: var(--text-secondary); margin: 0;">By division</p>
                                        </div>
                                    </div>
                                    <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 12px;">Field trip expenses by division including destination, transportation, and admission costs.</p>
                                    <button class="header-button" style="width: 100%;">
                                        <i class="fas fa-download"></i> Generate Report
                                    </button>
                                </div>

                                <!-- Amazon/Warehouse Report (NEW) -->
                                <div class="report-card" style="border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; cursor: pointer; transition: all 0.2s;" onclick="generateSupplyReportWithOptions()">
                                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                                        <div style="width: 48px; height: 48px; background: rgba(19, 56, 31, 0.1); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                            <i class="fas fa-shopping-cart" style="font-size: 24px; color: var(--primary-green);"></i>
                                        </div>
                                        <div>
                                            <h3 style="font-size: 16px; font-weight: 600; margin: 0;">Amazon/Warehouse</h3>
                                            <p style="font-size: 12px; color: var(--text-secondary); margin: 0;">Classroom supplies</p>
                                        </div>
                                    </div>
                                    <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px;">Classroom supply orders by teacher, aggregatable to department or division.</p>
                                    <div style="margin-bottom: 12px;">
                                        <select id="supplyAggregateLevel" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 13px;" onclick="event.stopPropagation()">
                                            <option value="teacher">By Teacher</option>
                                            <option value="department">By Department</option>
                                            <option value="division">By Division</option>
                                        </select>
                                    </div>
                                    <button class="header-button" style="width: 100%;">
                                        <i class="fas fa-download"></i> Generate Report
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Report Filters -->
                    <div class="chart-container">
                        <div class="chart-header">
                            <h2 class="chart-title">Report Filters</h2>
                        </div>
                        <div style="padding: 16px;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px;">
                                <div class="form-group">
                                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">Date Range</label>
                                    <select id="reportDateRange" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 14px;">
                                        <option value="ytd">Year to Date</option>
                                        <option value="quarter">Current Quarter</option>
                                        <option value="month">Current Month</option>
                                        <option value="custom">Custom Range</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">Division</label>
                                    <select id="reportDivision" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 14px;">
                                        <option value="all">All Divisions</option>
                                        <option value="US">Upper School</option>
                                        <option value="LS">Lower School</option>
                                        <option value="KK">Keswick Kids</option>
                                        <option value="AD">Administration</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">Status</label>
                                    <select id="reportStatus" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 14px;">
                                        <option value="all">All Statuses</option>
                                        <option value="approved">Approved</option>
                                        <option value="pending">Pending</option>
                                        <option value="processing">Processing</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">Format</label>
                                    <select id="reportFormat" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 14px;">
                                        <option value="csv">CSV (Excel Compatible)</option>
                                        <option value="json">JSON (Data Export)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Reports Preview -->
                    <div class="chart-container">
                        <div class="chart-header">
                            <h2 class="chart-title">Report Preview</h2>
                        </div>
                        <div id="reportPreview" style="padding: 16px;">
                            <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                                <i class="fas fa-file-alt" style="font-size: 32px; margin-bottom: 12px;"></i>
                                <p>Select a report type above to preview and download</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="analyticsTab" class="tab-content">
                    <!-- Analytics content -->
                    <!-- Enhanced Analytics KPIs -->
                    <div id="analyticsKpiGrid" class="widget-grid">
                        <!-- Analytics KPIs: Variance, Approval Time, Cost/Student, Step Up -->
                    </div>

                    <!-- Department Variance Chart (NEW) -->
                    <div class="chart-container">
                        <div class="chart-header">
                            <h2 class="chart-title">Spending Variance by Department</h2>
                            <p style="color: var(--text-secondary); font-size: 12px; margin-top: 4px;">Over/under budget by department</p>
                        </div>
                        <div style="padding: 16px;">
                            <canvas id="departmentVarianceChart" height="300"></canvas>
                        </div>
                    </div>

                    <!-- Two-column layout: Approval Turnaround & Cost Per Student -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <!-- Approval Turnaround Metrics (NEW) -->
                        <div class="chart-container">
                            <div class="chart-header">
                                <h2 class="chart-title">Approval Turnaround</h2>
                                <p style="color: var(--text-secondary); font-size: 12px; margin-top: 4px;">Time to process approvals</p>
                            </div>
                            <div style="padding: 16px;">
                                <div id="approvalMetricsGrid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                    <!-- Approval metrics cards -->
                                </div>
                            </div>
                        </div>

                        <!-- Cost Per Student by Division (NEW) -->
                        <div class="chart-container">
                            <div class="chart-header">
                                <h2 class="chart-title">Cost Per Student</h2>
                                <p style="color: var(--text-secondary); font-size: 12px; margin-top: 4px;">Spending normalized by enrollment</p>
                            </div>
                            <div style="padding: 16px;">
                                <canvas id="costPerStudentChart" height="200"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Monthly Spending Trend -->
                    <div class="chart-container">
                        <div class="chart-header">
                            <h2 class="chart-title">Monthly Spending Trend</h2>
                            <p style="color: var(--text-secondary); font-size: 12px; margin-top: 4px;">Budget vs Actual spending over time</p>
                        </div>
                        <div style="padding: 16px;">
                            <canvas id="monthlyTrendChart" height="250"></canvas>
                        </div>
                    </div>

                    <!-- Two-column layout for breakdowns -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <!-- Categorical Spending Breakdown -->
                        <div class="chart-container">
                            <div class="chart-header">
                                <h2 class="chart-title">Spending by Category</h2>
                            </div>
                            <div style="padding: 16px;">
                                <canvas id="categoricalChart" height="250"></canvas>
                            </div>
                        </div>

                        <!-- Division Comparison -->
                        <div class="chart-container">
                            <div class="chart-header">
                                <h2 class="chart-title">Division Comparison</h2>
                            </div>
                            <div style="padding: 16px;">
                                <canvas id="divisionComparisonChart" height="250"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Historical Comparison Placeholder -->
                    <div class="chart-container">
                        <div class="chart-header">
                            <h2 class="chart-title">Historical Comparison</h2>
                            <p style="color: var(--text-secondary); font-size: 12px; margin-top: 4px;">Year-over-year spending analysis</p>
                        </div>
                        <div style="padding: 24px; text-align: center; color: var(--text-secondary);">
                            <i class="fas fa-chart-line" style="font-size: 48px; opacity: 0.3; margin-bottom: 16px;"></i>
                            <p>Historical comparison data will be available after the first full fiscal year.</p>
                            <p style="font-size: 12px;">Current fiscal year data is being collected for future analysis.</p>
                        </div>
                    </div>

                    <!-- Financial Health Metrics -->
                    <div class="chart-container">
                        <div class="chart-header">
                            <h2 class="chart-title">Financial Health Indicators</h2>
                        </div>
                        <div style="padding: 16px;">
                            <div id="healthMetrics" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                                <!-- Health metrics will be inserted here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        </div><!-- End dashboard-container (sidebar + main) -->
    </div><!-- End dashboardContainer -->

    <!-- Debug Console will be injected here by JavaScript -->

    <script>
        // ============================================================================
        // DEBUG SYSTEM
        // ============================================================================
        
        class DashboardDebugger {
            constructor() {
                this.logs = [];
                this.startTime = Date.now();
                this.isOpen = false;
                this.filters = { level: 'all', category: 'all' };
                this.enabled = true; // Set to false in production
                
                if (this.enabled) {
                    this.initializeDebugConsole();
                    this.interceptErrors();
                    this.interceptNetworkCalls();
                }
            }
            
            log(message, data = null, category = 'general') {
                this.addLog('info', message, data, category);
            }
            
            debug(message, data = null, category = 'general') {
                this.addLog('debug', message, data, category);
            }
            
            warn(message, data = null, category = 'general') {
                this.addLog('warn', message, data, category);
            }
            
            error(message, data = null, category = 'general') {
                this.addLog('error', message, data, category);
                // Don't auto-open debug console on errors in production
                // if (!this.isOpen) this.toggle();
            }
            
            addLog(level, message, data, category) {
                const logEntry = {
                    id: Date.now() + Math.random(),
                    timestamp: new Date().toISOString(),
                    elapsed: Date.now() - this.startTime,
                    level: level,
                    category: category,
                    message: message,
                    data: data
                };
                
                this.logs.push(logEntry);
                if (this.logs.length > 500) this.logs.shift();
                
                if (this.isOpen) {
                    this.addLogToConsole(logEntry);
                }
                
                // Also log to browser console
                console[level === 'error' ? 'error' : level === 'warn' ? 'warn' : 'log'](
                    `[${category}] ${message}`, data
                );
                
                this.updateBadge();
            }
            
            initializeDebugConsole() {
                const debugHtml = `
                    <div id="debugConsole" class="debug-console hidden">
                        <div class="debug-header">
                            <div class="debug-title">
                                <i class="fas fa-bug"></i>
                                Debug Console
                                <span class="debug-stats">
                                    <span id="debugLogCount">0</span> logs | 
                                    <span id="debugElapsed">0s</span>
                                </span>
                            </div>
                            <div class="debug-controls">
                                <select id="debugLevelFilter" class="debug-filter">
                                    <option value="all">All Levels</option>
                                    <option value="debug">Debug</option>
                                    <option value="info">Info</option>
                                    <option value="warn">Warnings</option>
                                    <option value="error">Errors</option>
                                </select>
                                <select id="debugCategoryFilter" class="debug-filter">
                                    <option value="all">All Categories</option>
                                    <option value="auth">Authentication</option>
                                    <option value="data">Data Loading</option>
                                    <option value="render">Rendering</option>
                                    <option value="network">Network</option>
                                    <option value="general">General</option>
                                </select>
                                <button id="debugClear" class="debug-btn">
                                    <i class="fas fa-trash"></i> Clear
                                </button>
                                <button id="debugExport" class="debug-btn">
                                    <i class="fas fa-download"></i> Export
                                </button>
                                <button id="debugClose" class="debug-btn">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <div class="debug-body">
                            <div id="debugLogs" class="debug-logs"></div>
                        </div>
                        <div class="debug-footer">
                            <div class="debug-actions">
                                <button onclick="window.dashDebugger.runDiagnostics()" class="debug-btn primary">
                                    <i class="fas fa-stethoscope"></i> Run Diagnostics
                                </button>
                                <button onclick="window.dashDebugger.testConnections()" class="debug-btn">
                                    <i class="fas fa-network-wired"></i> Test Connections
                                </button>
                                <button onclick="window.dashDebugger.clearCache()" class="debug-btn">
                                    <i class="fas fa-broom"></i> Clear Cache
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <button id="debugToggle" class="debug-toggle">
                        <i class="fas fa-bug"></i>
                        <span class="debug-badge hidden">0</span>
                    </button>
                `;
                
                document.body.insertAdjacentHTML('beforeend', debugHtml);
                this.setupEventListeners();
                this.startUpdateTimer();
            }
            
            setupEventListeners() {
                document.getElementById('debugToggle').addEventListener('click', () => this.toggle());
                document.getElementById('debugClose').addEventListener('click', () => this.toggle());
                document.getElementById('debugClear').addEventListener('click', () => this.clearLogs());
                document.getElementById('debugExport').addEventListener('click', () => this.exportLogs());
                
                document.getElementById('debugLevelFilter').addEventListener('change', (e) => {
                    this.filters.level = e.target.value;
                    this.refreshLogs();
                });
                
                document.getElementById('debugCategoryFilter').addEventListener('change', (e) => {
                    this.filters.category = e.target.value;
                    this.refreshLogs();
                });
            }
            
            toggle() {
                this.isOpen = !this.isOpen;
                document.getElementById('debugConsole').classList.toggle('hidden');
                if (this.isOpen) this.refreshLogs();
            }
            
            addLogToConsole(logEntry) {
                const logsContainer = document.getElementById('debugLogs');
                
                if (this.filters.level !== 'all' && logEntry.level !== this.filters.level) return;
                if (this.filters.category !== 'all' && logEntry.category !== this.filters.category) return;
                
                const logElement = document.createElement('div');
                logElement.className = `debug-log-entry ${logEntry.level}`;
                
                const timestamp = new Date(logEntry.timestamp).toLocaleTimeString();
                const elapsed = (logEntry.elapsed / 1000).toFixed(2);
                
                logElement.innerHTML = `
                    <div class="debug-log-header">
                        <div>
                            <span class="debug-log-level ${logEntry.level}">${logEntry.level}</span>
                            <span class="debug-log-meta">[${logEntry.category}]</span>
                        </div>
                        <span class="debug-log-meta">${timestamp} (+${elapsed}s)</span>
                    </div>
                    <div class="debug-log-message">${logEntry.message}</div>
                    ${logEntry.data ? `<div class="debug-log-data">${JSON.stringify(logEntry.data, null, 2)}</div>` : ''}
                `;
                
                logsContainer.appendChild(logElement);
                logsContainer.scrollTop = logsContainer.scrollHeight;
            }
            
            refreshLogs() {
                const logsContainer = document.getElementById('debugLogs');
                logsContainer.innerHTML = '';
                this.logs.forEach(log => this.addLogToConsole(log));
            }
            
            clearLogs() {
                this.logs = [];
                document.getElementById('debugLogs').innerHTML = '';
                this.updateBadge();
            }
            
            exportLogs() {
                const exportData = {
                    timestamp: new Date().toISOString(),
                    userAgent: navigator.userAgent,
                    logs: this.logs,
                    diagnostics: this.getSystemDiagnostics()
                };
                
                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `dashboard-debug-${Date.now()}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                this.log('Debug logs exported', null, 'system');
            }
            
            updateBadge() {
                const errorCount = this.logs.filter(log => log.level === 'error').length;
                const badge = document.querySelector('.debug-badge');
                
                if (errorCount > 0) {
                    badge.textContent = errorCount;
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }
            }
            
            startUpdateTimer() {
                setInterval(() => {
                    if (this.isOpen) {
                        document.getElementById('debugLogCount').textContent = this.logs.length;
                        document.getElementById('debugElapsed').textContent = 
                            Math.floor((Date.now() - this.startTime) / 1000) + 's';
                    }
                }, 1000);
            }
            
            interceptErrors() {
                window.addEventListener('error', (event) => {
                    this.error('JavaScript Error', {
                        message: event.message,
                        source: event.filename,
                        line: event.lineno,
                        column: event.colno,
                        error: event.error?.stack
                    }, 'error');
                });
                
                window.addEventListener('unhandledrejection', (event) => {
                    this.error('Unhandled Promise Rejection', {
                        reason: event.reason,
                        promise: event.promise
                    }, 'error');
                });
            }
            
            interceptNetworkCalls() {
                if (typeof google !== 'undefined' && google.script && google.script.run) {
                    const originalRun = google.script.run;
                    const debuggerInstance = this;
                    
                    // Create proxy for google.script.run
                    const methods = ['withSuccessHandler', 'withFailureHandler'];
                    methods.forEach(method => {
                        const original = originalRun[method];
                        originalRun[method] = function(handler) {
                            const wrappedHandler = function(...args) {
                                debuggerInstance.log(`${method} called`, args, 'network');
                                return handler(...args);
                            };
                            return original.call(this, wrappedHandler);
                        };
                    });
                }
            }
            
            async runDiagnostics() {
                this.log('Starting system diagnostics...', null, 'system');
                
                const diagnostics = {
                    browser: this.getBrowserInfo(),
                    performance: this.getPerformanceMetrics(),
                    storage: this.getStorageInfo(),
                    network: await this.getNetworkStatus(),
                    dom: this.getDOMStats()
                };
                
                this.log('Diagnostics complete', diagnostics, 'system');
                alert('Diagnostics Complete! Check the debug console for details.');
                
                return diagnostics;
            }
            
            getBrowserInfo() {
                return {
                    userAgent: navigator.userAgent,
                    platform: navigator.platform,
                    language: navigator.language,
                    cookiesEnabled: navigator.cookieEnabled,
                    onLine: navigator.onLine,
                    screenResolution: `${screen.width}x${screen.height}`,
                    windowSize: `${window.innerWidth}x${window.innerHeight}`,
                    pixelRatio: window.devicePixelRatio
                };
            }
            
            getPerformanceMetrics() {
                const navigation = performance.getEntriesByType('navigation')[0];
                return {
                    pageLoadTime: navigation?.loadEventEnd - navigation?.fetchStart,
                    domContentLoaded: navigation?.domContentLoadedEventEnd - navigation?.domContentLoadedEventStart,
                    resourceCount: performance.getEntriesByType('resource').length,
                    memoryUsage: performance.memory ? {
                        usedJSHeapSize: Math.round(performance.memory.usedJSHeapSize / 1048576) + ' MB',
                        totalJSHeapSize: Math.round(performance.memory.totalJSHeapSize / 1048576) + ' MB',
                        jsHeapSizeLimit: Math.round(performance.memory.jsHeapSizeLimit / 1048576) + ' MB'
                    } : 'Not available'
                };
            }
            
            getStorageInfo() {
                const getStorageSize = (storage) => {
                    let size = 0;
                    for (let key in storage) {
                        size += storage[key].length + key.length;
                    }
                    return Math.round(size / 1024) + ' KB';
                };
                
                return {
                    localStorage: {
                        size: getStorageSize(localStorage),
                        keys: Object.keys(localStorage).length
                    },
                    sessionStorage: {
                        size: getStorageSize(sessionStorage),
                        keys: Object.keys(sessionStorage).length
                    }
                };
            }
            
            async getNetworkStatus() {
                try {
                    const startTime = Date.now();
                    
                    return new Promise((resolve) => {
                        const timeout = setTimeout(() => {
                            resolve({
                                status: 'timeout',
                                responseTime: Date.now() - startTime,
                                message: 'Network request timed out'
                            });
                        }, 5000);
                        
                        if (typeof google !== 'undefined' && google.script && google.script.run) {
                            google.script.run
                                .withSuccessHandler(() => {
                                    clearTimeout(timeout);
                                    resolve({
                                        status: 'connected',
                                        responseTime: Date.now() - startTime,
                                        message: 'Successfully connected to server'
                                    });
                                })
                                .withFailureHandler((error) => {
                                    clearTimeout(timeout);
                                    resolve({
                                        status: 'error',
                                        responseTime: Date.now() - startTime,
                                        message: error.message,
                                        error: error
                                    });
                                })
                                .getWebAppUrl();
                        } else {
                            clearTimeout(timeout);
                            resolve({
                                status: 'unavailable',
                                message: 'Google Script API not available'
                            });
                        }
                    });
                } catch (error) {
                    return {
                        status: 'error',
                        message: 'Failed to test network connection',
                        error: error.message
                    };
                }
            }
            
            getDOMStats() {
                return {
                    totalElements: document.getElementsByTagName('*').length,
                    scripts: document.scripts.length,
                    stylesheets: document.styleSheets.length,
                    images: document.images.length,
                    forms: document.forms.length
                };
            }
            
            getSystemDiagnostics() {
                return {
                    browser: this.getBrowserInfo(),
                    performance: this.getPerformanceMetrics(),
                    storage: this.getStorageInfo(),
                    dom: this.getDOMStats()
                };
            }
            
            async testConnections() {
                this.log('Testing server connections...', null, 'network');
                
                const tests = [
                    { name: 'Web App URL', method: 'getWebAppUrl' },
                    { name: 'Dashboard Data', method: 'getDashboardData' }
                ];
                
                for (const test of tests) {
                    try {
                        const startTime = Date.now();
                        await this.testServerMethod(test.method);
                        const elapsed = Date.now() - startTime;
                        
                        this.log(` ${test.name} - Success (${elapsed}ms)`, null, 'network');
                    } catch (error) {
                        this.error(` ${test.name} - Failed`, error, 'network');
                    }
                }
            }
            
            testServerMethod(methodName) {
                return new Promise((resolve, reject) => {
                    const timeout = setTimeout(() => {
                        reject(new Error('Timeout after 10 seconds'));
                    }, 10000);
                    
                    if (typeof google !== 'undefined' && google.script && google.script.run && google.script.run[methodName]) {
                        google.script.run
                            .withSuccessHandler((result) => {
                                clearTimeout(timeout);
                                resolve(result);
                            })
                            .withFailureHandler((error) => {
                                clearTimeout(timeout);
                                reject(error);
                            })[methodName]();
                    } else {
                        clearTimeout(timeout);
                        reject(new Error(`Method ${methodName} not available`));
                    }
                });
            }
            
            clearCache() {
                try {
                    localStorage.clear();
                    sessionStorage.clear();
                    this.log('Cache cleared successfully', null, 'system');
                    
                    if (confirm('Cache cleared. Reload the page now?')) {
                        window.location.reload();
                    }
                } catch (error) {
                    this.error('Failed to clear cache', error, 'system');
                }
            }
        }
        
        // ============================================================================
        // GLOBAL VARIABLES
        // ============================================================================
        
        let currentUser = null;
        let dashboardData = null;
        let currentTab = 'overview';
        let isLoading = false;
        let isDemoMode = false;
        let charts = {};
        let loadingTimeout = null;
        let dashDebugger = null;

        // Role Switcher State (Demo Mode Only)
        let simulatedRole = null;        // null = using real role
        let simulatedDivision = null;
        let simulatedDepartment = null;
        let availableDivisions = [];
        let availableDepartments = [];
        
        // ============================================================================
        // INITIALIZATION
        // ============================================================================
        
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize debugger first
            dashDebugger = new DashboardDebugger();
            window.dashDebugger = dashDebugger; // Make available globally
            
            dashDebugger.log(' Dashboard initialized', {
                timestamp: new Date().toISOString(),
                url: window.location.href
            }, 'init');
            
            initializeEventListeners();
            loadDashboard();
        });
        
        function initializeEventListeners() {
            dashDebugger.log('Setting up event listeners', null, 'init');
            
            // Menu toggle
            document.getElementById('menuToggle').addEventListener('click', toggleSidebar);
            
            // Tab navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function() {
                    switchTab(this.dataset.tab);
                });
            });
        }
        
        // ============================================================================
        // DASHBOARD LOADING - ENHANCED WITH DEBUGGING
        // ============================================================================
        
        async function loadDashboard() {
            dashDebugger.log(' Loading dashboard...', null, 'init');
            updateLoadingStatus('Connecting to server...');
            
            try {
                // Test Google Script availability
                if (typeof google === 'undefined' || !google.script || !google.script.run) {
                    dashDebugger.warn(' Google Script API not available - loading demo mode', null, 'init');
                    loadDemoMode();
                    return;
                }
                dashDebugger.log(' Google Script API available', null, 'init');
                
                // Set loading timeout - increased to 30 seconds
                loadingTimeout = setTimeout(() => {
                    dashDebugger.warn(' Loading timeout reached', { duration: 30000 }, 'network');
                    handleLoadingTimeout();
                }, 30000);
                
                updateLoadingStatus('Authenticating user...');
                dashDebugger.log('Calling getDashboardData...', null, 'network');
                
                const startTime = Date.now();
                
                // Call the server function
                google.script.run
                    .withSuccessHandler((response) => {
                        clearTimeout(loadingTimeout);
                        const elapsed = Date.now() - startTime;
                        
                        dashDebugger.log(' Server response received', {
                            elapsed: elapsed + 'ms',
                            success: response?.success,
                            hasUser: !!response?.user,
                            hasData: !!response?.data,
                            error: response?.error
                        }, 'network');
                        
                        handleDashboardResponse(response);
                    })
                    .withFailureHandler((error) => {
                        clearTimeout(loadingTimeout);
                        const elapsed = Date.now() - startTime;
                        
                        dashDebugger.error(' Server call failed', {
                            elapsed: elapsed + 'ms',
                            error: error.message,
                            stack: error.stack
                        }, 'network');
                        
                        handleDashboardError(error);
                    })
                    .getDashboardData();
                    
            } catch (error) {
                dashDebugger.error(' Dashboard initialization error', {
                    message: error.message,
                    stack: error.stack
                }, 'init');
                
                handleDashboardError(error);
            }
        }
        
        function handleDashboardResponse(response) {
            dashDebugger.log('Processing dashboard response', response, 'data');

            if (!response) {
                handleDashboardError(new Error('Empty response from server'));
                return;
            }

            if (response.success) {
                currentUser = response.user;
                dashboardData = response.data;

                // Check if server returned demo mode explicitly or via warning
                const isServerDemo = response.isDemo === true ||
                                    response.warning?.toLowerCase().includes('demo') ||
                                    response.warning?.toLowerCase().includes('fallback');

                // Set demo mode flag
                isDemoMode = isServerDemo;

                // Hide error alert in demo mode (demo data is intentional, not an error)
                if (isDemoMode) {
                    const errorAlert = document.getElementById('errorAlert');
                    if (errorAlert) errorAlert.classList.add('hidden');
                }

                dashDebugger.log('Dashboard data loaded successfully', {
                    user: currentUser?.email,
                    role: currentUser?.role,
                    dataKeys: dashboardData ? Object.keys(dashboardData) : [],
                    isDemo: isDemoMode,
                    warning: response.warning
                }, 'data');

                // Update UI with user info
                updateUserInterface();

                // Render dashboard
                renderDashboard();

                // Show data mode banner - use response.isDemo flag directly
                // (Don't check server mode - just trust the response)
                updateDataModeBanner(isDemoMode);

                // Hide loading, show dashboard
                hideLoading();
                showDashboard();

            } else if (response.fallbackData) {
                // Use fallback data
                dashDebugger.warn(' Using fallback data', response, 'data');
                isDemoMode = true;
                currentUser = response.fallbackData.user;

                // Load demo dashboard
                loadDemoMode();

            } else if (response.error === 'ACCESS_DENIED') {
                // User not authorized - show access denied message
                dashDebugger.error(' Access denied', response, 'auth');
                handleAccessDenied(response.message || 'You do not have permission to access this dashboard.');

            } else {
                handleDashboardError(new Error(response.error || 'Failed to load dashboard'));
            }
        }

        function handleAccessDenied(message) {
            clearTimeout(loadingTimeout);
            updateLoadingStatus('Access Denied');

            const errorContainer = document.getElementById('loadingError');
            errorContainer.classList.remove('hidden');

            // Update error display for access denied
            const errorTitle = errorContainer.querySelector('.loading-error-title') ||
                              errorContainer.querySelector('h3') ||
                              document.createElement('div');
            if (errorTitle) errorTitle.textContent = 'Access Denied';

            const errorMessage = document.querySelector('.loading-error-message');
            if (errorMessage) {
                errorMessage.textContent = message;
            }

            // Hide retry button for access denied (won't help)
            const retryBtn = errorContainer.querySelector('button[onclick*="retry"]');
            if (retryBtn) retryBtn.style.display = 'none';
        }

        function handleDashboardError(error) {
            clearTimeout(loadingTimeout);
            dashDebugger.error(' Dashboard error', error, 'error');

            updateLoadingStatus('Connection failed');
            document.getElementById('loadingError').classList.remove('hidden');

            // Show error in loading screen
            const errorMessage = document.querySelector('.loading-error-message');
            if (error.message) {
                errorMessage.textContent = error.message;
            }
        }
        
        function handleLoadingTimeout() {
            dashDebugger.warn(' Loading timeout - showing error options', null, 'network');
            updateLoadingStatus('Taking longer than expected...');
            document.getElementById('loadingError').classList.remove('hidden');
        }
        
        function updateLoadingStatus(message) {
            document.getElementById('loadingStatus').textContent = message;
            dashDebugger.debug(`Loading status: ${message}`, null, 'ui');
        }
        
        // ============================================================================
        // RETRY AND DEMO MODE
        // ============================================================================
        
        function retryConnection() {
            dashDebugger.log(' Retrying connection...', null, 'network');
            document.getElementById('loadingError').classList.add('hidden');
            updateLoadingStatus('Retrying connection...');
            loadDashboard();
        }
        
        function loadDemoMode() {
            dashDebugger.log(' Loading demo mode...', null, 'data');
            isDemoMode = true;

            // Create demo user if not provided
            if (!currentUser) {
                currentUser = {
                    email: 'demo@keswickchristian.org',
                    firstName: 'Demo',
                    lastName: 'User',
                    role: 'executive'
                };
            }

            // Generate demo data
            dashboardData = generateDemoData();

            dashDebugger.log('Demo data generated', {
                kpis: dashboardData.kpis.length,
                divisions: dashboardData.divisionSummary.length,
                transactions: dashboardData.transactions.length
            }, 'data');

            // Update UI
            updateUserInterface();
            renderDashboard();

            // Show data mode banner
            updateDataModeBanner(true);

            // Hide loading, show dashboard
            hideLoading();
            showDashboard();
        }

        // ============================================================================
        // DATA MODE (DEMO/LIVE) FUNCTIONS
        // ============================================================================

        let serverDemoMode = null; // Track server-side demo mode

        /**
         * Check demo mode status from server
         */
        async function checkServerDemoMode() {
            if (typeof google === 'undefined' || !google.script || !google.script.run) {
                return null; // Can't check - running locally
            }

            return new Promise((resolve) => {
                google.script.run
                    .withSuccessHandler((response) => {
                        serverDemoMode = response?.demoMode ?? null;
                        resolve(serverDemoMode);
                    })
                    .withFailureHandler(() => {
                        resolve(null);
                    })
                    .getDemoMode();
            });
        }

        /**
         * Update the data mode banner display
         */
        function updateDataModeBanner(isDemo) {
            const banner = document.getElementById('dataModeBanner');
            const message = document.getElementById('dataModeMessage');
            const toggleBtn = document.getElementById('toggleModeBtn');
            const legacyBanner = document.getElementById('demoBanner');

            if (!banner) return;

            // Update banner class and content
            banner.classList.remove('hidden');
            if (isDemo) {
                banner.classList.remove('live-mode');
                banner.classList.add('demo-mode');
                message.innerHTML = '<strong>Demo Mode:</strong> You\'re viewing sample data. Some features may be limited.';
                toggleBtn.innerHTML = '<i class="fas fa-exchange-alt"></i> Switch to Live';
            } else {
                banner.classList.remove('demo-mode');
                banner.classList.add('live-mode');
                message.innerHTML = '<strong>Live Mode:</strong> Displaying real-time data from Budget Hub.';
                toggleBtn.innerHTML = '<i class="fas fa-exchange-alt"></i> Switch to Demo';
            }

            // Show toggle button for executives
            if (currentUser?.role === 'executive') {
                toggleBtn.classList.remove('hidden');
            }

            // Hide legacy banner
            if (legacyBanner) {
                legacyBanner.classList.add('hidden');
            }

            // Initialize role switcher (only shows in demo mode)
            initRoleSwitcher();
        }

        /**
         * Toggle between demo and live mode (executive only)
         */
        function toggleDataMode() {
            // Reset role switcher state when toggling modes
            resetRoleSwitcher();
            if (currentUser?.role !== 'executive') {
                alert('Only executives can toggle data mode.');
                return;
            }

            const newMode = !isDemoMode;
            const action = newMode ? 'demo' : 'live';

            if (!confirm(`Switch to ${action.toUpperCase()} mode?\n\n${newMode ? 'This will show sample data.' : 'This will show real data from Budget Hub.'}`)) {
                return;
            }

            // If running locally, just toggle client-side
            if (typeof google === 'undefined' || !google.script || !google.script.run) {
                isDemoMode = newMode;
                if (newMode) {
                    dashboardData = generateDemoData();
                }
                updateDataModeBanner(newMode);
                renderDashboard();
                return;
            }

            // Toggle on server
            google.script.run
                .withSuccessHandler((response) => {
                    if (response.success) {
                        isDemoMode = response.demoMode;
                        serverDemoMode = response.demoMode;
                        updateDataModeBanner(isDemoMode);

                        // Reload data
                        loadDashboard();
                    } else {
                        alert('Failed to toggle mode: ' + (response.error || 'Unknown error'));
                    }
                })
                .withFailureHandler((error) => {
                    alert('Failed to toggle mode: ' + error.message);
                })
                .setDemoMode(newMode);
        }

        // ============================================================================
        // ROLE SWITCHER FUNCTIONS (Demo Mode Only)
        // ============================================================================

        /**
         * Initialize role switcher when demo mode is active
         */
        function initRoleSwitcher() {
            const container = document.getElementById('roleSwitcherContainer');
            if (!container) return;

            // Only show in demo mode
            if (!isDemoMode) {
                container.classList.add('hidden');
                return;
            }

            // Show role switcher in demo mode
            container.classList.remove('hidden');
            loadAvailableDivisions();

            // Reset dropdowns to executive
            const roleSelect = document.getElementById('roleSelect');
            if (roleSelect) roleSelect.value = 'executive';
            document.getElementById('divisionSelect')?.classList.add('hidden');
            document.getElementById('departmentSelect')?.classList.add('hidden');
        }

        /**
         * Load available divisions from backend
         */
        function loadAvailableDivisions() {
            if (typeof google === 'undefined' || !google.script || !google.script.run) {
                // Hardcoded divisions for local testing
                availableDivisions = [
                    { code: 'US', name: 'Upper School' },
                    { code: 'LS', name: 'Lower School' },
                    { code: 'KK', name: 'Keswick Kids' },
                    { code: 'AD', name: 'Administration' }
                ];
                populateDivisionDropdown();
                return;
            }

            google.script.run
                .withSuccessHandler((response) => {
                    if (response.success) {
                        availableDivisions = response.divisions;
                        populateDivisionDropdown();
                    }
                })
                .withFailureHandler((error) => {
                    console.error('Failed to load divisions:', error);
                })
                .getAvailableDivisions();
        }

        /**
         * Populate division dropdown with available divisions
         */
        function populateDivisionDropdown() {
            const select = document.getElementById('divisionSelect');
            if (!select) return;

            select.innerHTML = '<option value="">Select Division...</option>';
            availableDivisions.forEach(div => {
                const option = document.createElement('option');
                option.value = div.code;
                option.textContent = div.name;
                select.appendChild(option);
            });
        }

        /**
         * Load departments for selected division
         */
        function loadDepartmentsForDivision(divisionCode) {
            if (typeof google === 'undefined' || !google.script || !google.script.run) {
                // Mock departments for local testing
                const mockDepts = {
                    'US': ['Math', 'Science', 'English', 'History', 'Fine Arts', 'Athletics'],
                    'LS': ['Elementary', 'Art', 'Music', 'PE', 'Library'],
                    'KK': ['Keswick Kids', 'Early Childhood'],
                    'AD': ['Administration', 'Finance', 'HR', 'Facilities']
                };
                availableDepartments = (mockDepts[divisionCode] || []).map(d => ({ code: d, name: d }));
                populateDepartmentDropdown();
                return;
            }

            google.script.run
                .withSuccessHandler((response) => {
                    if (response.success) {
                        availableDepartments = response.departments;
                        populateDepartmentDropdown();
                    }
                })
                .withFailureHandler((error) => {
                    console.error('Failed to load departments:', error);
                })
                .getDepartmentsByDivision(divisionCode);
        }

        /**
         * Populate department dropdown
         */
        function populateDepartmentDropdown() {
            const select = document.getElementById('departmentSelect');
            if (!select) return;

            select.innerHTML = '<option value="">Select Department...</option>';
            availableDepartments.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept.code;
                option.textContent = dept.name;
                select.appendChild(option);
            });
        }

        /**
         * Handle role dropdown change
         */
        function onRoleChange(role) {
            simulatedRole = role;
            simulatedDivision = null;
            simulatedDepartment = null;

            const divisionSelect = document.getElementById('divisionSelect');
            const departmentSelect = document.getElementById('departmentSelect');

            // Reset dropdowns
            if (divisionSelect) divisionSelect.value = '';
            if (departmentSelect) departmentSelect.value = '';
            departmentSelect?.classList.add('hidden');

            if (role === 'executive') {
                divisionSelect?.classList.add('hidden');
                reloadDashboardAsRole();
            } else {
                // Principal or Department Head need division selection
                divisionSelect?.classList.remove('hidden');
            }
        }

        /**
         * Handle division dropdown change
         */
        function onDivisionChange(division) {
            if (!division) return;

            simulatedDivision = division;
            simulatedDepartment = null;

            const departmentSelect = document.getElementById('departmentSelect');

            if (simulatedRole === 'department_head') {
                departmentSelect?.classList.remove('hidden');
                loadDepartmentsForDivision(division);
            } else if (simulatedRole === 'principal') {
                departmentSelect?.classList.add('hidden');
                reloadDashboardAsRole();
            }
        }

        /**
         * Handle department dropdown change
         */
        function onDepartmentChange(department) {
            if (!department) return;

            simulatedDepartment = department;
            reloadDashboardAsRole();
        }

        /**
         * Reload dashboard with simulated role
         */
        function reloadDashboardAsRole() {
            if (!simulatedRole || simulatedRole === 'executive') {
                // Reset to actual user view
                simulatedRole = null;
                simulatedDivision = null;
                simulatedDepartment = null;
                loadDashboard();
                return;
            }

            dashDebugger?.log('Reloading dashboard as role', {
                role: simulatedRole,
                division: simulatedDivision,
                department: simulatedDepartment
            }, 'role-switcher');

            if (typeof google === 'undefined' || !google.script || !google.script.run) {
                // Local testing: generate mock data filtered by role
                const fullData = generateDemoData();
                const filteredData = filterDataForRole(fullData, simulatedRole, simulatedDivision, simulatedDepartment);

                handleSimulatedRoleResponse({
                    success: true,
                    user: {
                        ...currentUser,
                        role: simulatedRole,
                        divisions: simulatedDivision ? [simulatedDivision] : currentUser?.divisions,
                        departments: simulatedDepartment ? [simulatedDepartment] : currentUser?.departments,
                        isSimulated: true
                    },
                    data: filteredData,
                    isSimulated: true
                });
                return;
            }

            google.script.run
                .withSuccessHandler(handleSimulatedRoleResponse)
                .withFailureHandler((error) => {
                    dashDebugger?.error('Role simulation failed', error, 'role-switcher');
                    alert('Failed to switch role: ' + error.message);
                })
                .getDashboardDataAsRole(simulatedRole, simulatedDivision, simulatedDepartment);
        }

        /**
         * Handle response from simulated role request
         */
        function handleSimulatedRoleResponse(response) {
            if (response.success) {
                currentUser = response.user;
                dashboardData = response.data;

                updateUserInterface();
                renderDashboard();

                // Update role display to show simulated state
                const userRoleEl = document.getElementById('userRole');
                if (userRoleEl && response.isSimulated) {
                    const roleLabel = response.user.role.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
                    userRoleEl.textContent = `Viewing as: ${roleLabel}`;
                }
            } else {
                alert('Failed to switch role: ' + response.error);
            }
        }

        /**
         * Reset role switcher state
         */
        function resetRoleSwitcher() {
            simulatedRole = null;
            simulatedDivision = null;
            simulatedDepartment = null;

            const roleSelect = document.getElementById('roleSelect');
            const divisionSelect = document.getElementById('divisionSelect');
            const departmentSelect = document.getElementById('departmentSelect');

            if (roleSelect) roleSelect.value = 'executive';
            if (divisionSelect) {
                divisionSelect.value = '';
                divisionSelect.classList.add('hidden');
            }
            if (departmentSelect) {
                departmentSelect.value = '';
                departmentSelect.classList.add('hidden');
            }
        }

        // ============================================================================
        // UI UPDATE FUNCTIONS
        // ============================================================================
        
        function updateUserInterface() {
            dashDebugger.debug('Updating user interface', currentUser, 'ui');

            if (!currentUser) return;

            // Update user info
            const initials = (currentUser.firstName?.[0] || '') + (currentUser.lastName?.[0] || '');
            document.getElementById('userInitials').textContent = initials || 'U';
            document.getElementById('userName').textContent =
                `${currentUser.firstName || 'User'} ${currentUser.lastName || ''}`.trim();
            document.getElementById('userRole').textContent =
                currentUser.role?.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase()) || 'User';

            // Load school logo and brand assets
            loadSchoolLogo();
            loadBrandAssets();
        }

        function loadSchoolLogo() {
            if (typeof google === 'undefined' || !google.script || !google.script.run) {
                dashDebugger.debug('Skipping logo load - no google.script', null, 'ui');
                return;
            }

            google.script.run
                .withSuccessHandler(function(response) {
                    if (response && response.success && response.logo) {
                        const logoImg = document.getElementById('schoolLogo');
                        if (logoImg) {
                            logoImg.src = response.logo;
                            dashDebugger.debug('School logo loaded', { fileName: response.fileName }, 'ui');
                        }
                    } else {
                        dashDebugger.debug('Logo not loaded - using placeholder', response, 'ui');
                    }
                })
                .withFailureHandler(function(error) {
                    dashDebugger.debug('Logo load failed - using placeholder', { error: error.message }, 'ui');
                })
                .getSchoolLogo();
        }

        /**
         * Load brand assets (school logo) into sidebar
         */
        function loadBrandAssets() {
            dashDebugger.debug('Loading brand assets...', null, 'ui');

            // Helper to show text fallback when image fails
            function showTextFallback(elementId, fallbackText) {
                const img = document.getElementById(elementId);
                if (img && img.parentNode) {
                    const textDiv = document.createElement('div');
                    textDiv.style.cssText = 'font-family: "Lucida Bright", Georgia, serif; font-weight: 600; color: #13381f; font-size: 14px; padding: 8px 0;';
                    textDiv.textContent = fallbackText;
                    img.parentNode.replaceChild(textDiv, img);
                }
            }

            // Check if google.script is available
            if (typeof google === 'undefined' || !google.script || !google.script.run) {
                dashDebugger.warn('google.script not available, using text fallback', null, 'ui');
                showTextFallback('sidebarLogo', 'Keswick Christian School');
                return;
            }

            // Load school logo into sidebar
            google.script.run
                .withSuccessHandler(function(response) {
                    if (response && response.success && response.data) {
                        // Set sidebar logo
                        const sidebarLogo = document.getElementById('sidebarLogo');
                        const logoText = document.getElementById('sidebarLogoText');
                        if (sidebarLogo) {
                            sidebarLogo.src = 'data:image/png;base64,' + response.data;
                            sidebarLogo.style.display = 'block';
                            if (logoText) logoText.style.display = 'none';
                            dashDebugger.info('Sidebar logo loaded', { fileName: response.fileName }, 'ui');
                        }
                        // Also set hidden schoolNameLogo for compatibility
                        const hiddenLogo = document.getElementById('schoolNameLogo');
                        if (hiddenLogo) {
                            hiddenLogo.src = 'data:image/png;base64,' + response.data;
                        }
                    } else {
                        dashDebugger.warn('Logo load failed, using text fallback', response, 'ui');
                        showTextFallback('sidebarLogo', 'Keswick Christian School');
                    }
                })
                .withFailureHandler(function(error) {
                    dashDebugger.error('Logo error, using text fallback', { error: error.message }, 'ui');
                    showTextFallback('sidebarLogo', 'Keswick Christian School');
                })
                .getBrandAsset('school-name.png');
        }
        
        function hideLoading() {
            document.getElementById('loadingContainer').classList.add('hidden');
            dashDebugger.debug('Loading screen hidden', null, 'ui');
        }
        
        function showDashboard() {
            document.getElementById('dashboardContainer').classList.remove('hidden');
            dashDebugger.debug('Dashboard displayed', null, 'ui');
        }
        
        // ============================================================================
        // DASHBOARD RENDERING
        // ============================================================================
        
        function renderDashboard() {
            dashDebugger.log(' Rendering dashboard...', null, 'render');
            
            if (!dashboardData) {
                dashDebugger.warn('No dashboard data to render', null, 'render');
                showDataError();
                return;
            }
            
            try {
                // Render KPIs
                if (dashboardData.kpis) {
                    renderKPIs(dashboardData.kpis);
                }
                
                // Render division chart
                if (dashboardData.divisionSummary) {
                    renderDivisionChart(dashboardData.divisionSummary);
                    renderDivisionTable(dashboardData.divisionSummary);
                }
                
                // Render transactions
                if (dashboardData.transactions) {
                    renderTransactions(dashboardData.transactions);
                }
                
                // Show any alerts
                if (dashboardData.alerts && dashboardData.alerts.length > 0) {
                    showAlerts(dashboardData.alerts);
                }
                
                dashDebugger.log(' Dashboard rendered successfully', null, 'render');

                // Force chart update after short delay to fix initial render issue
                setTimeout(() => {
                    if (charts.division) {
                        charts.division.update();
                        dashDebugger.debug('Division chart updated (post-render fix)', null, 'render');
                    }
                }, 100);

            } catch (error) {
                dashDebugger.error('Render error', error, 'render');
                showDataError();
            }
        }
        
        function showDataError() {
            // Don't show error in demo mode - demo data is intentional
            if (isDemoMode) return;

            // Show error alert but auto-hide after 5 seconds
            const errorAlert = document.getElementById('errorAlert');
            if (errorAlert) {
                errorAlert.classList.remove('hidden');
                // Auto-hide after 5 seconds so it's not permanently obstructive
                setTimeout(() => {
                    errorAlert.classList.add('hidden');
                }, 5000);
            }
        }
        
        // ============================================================================
        // KPI RENDERING
        // ============================================================================
        
        function renderKPIs(kpis) {
            dashDebugger.debug('Rendering KPIs', { count: kpis.length }, 'render');
            
            const grid = document.getElementById('kpiGrid');
            grid.innerHTML = '';
            
            if (!kpis || kpis.length === 0) {
                grid.innerHTML = '<p class="text-muted">No KPI data available</p>';
                return;
            }
            
            kpis.forEach(kpi => {
                const card = createKPICard(kpi);
                grid.appendChild(card);
            });
        }
        
        function createKPICard(kpi) {
            const card = document.createElement('div');
            card.className = 'widget-card';
            
            const value = formatKPIValue(kpi.value, kpi.format);
            const trend = kpi.trend ? createTrendBadge(kpi.trend, kpi.trendValue) : '';
            
            card.innerHTML = `
                <div class="widget-header">
                    <h3 class="widget-title">${kpi.label}</h3>
                    ${kpi.urgent ? '<i class="fas fa-exclamation-circle widget-icon text-warning"></i>' : ''}
                </div>
                <div class="widget-value">${value}</div>
                <div class="widget-subtitle">${kpi.description || ''}</div>
                ${trend}
            `;
            
            return card;
        }
        
        function formatKPIValue(value, format) {
            switch (format) {
                case 'currency':
                    return '$' + value.toLocaleString();
                case 'percentage':
                    return value + '%';
                case 'number':
                    return value.toLocaleString();
                default:
                    return value;
            }
        }
        
        function createTrendBadge(trend, value) {
            const icon = trend === 'up' ? 'fa-arrow-up' : 'fa-arrow-down';
            const text = value ? `${value}%` : '';
            return `<div class="widget-trend ${trend}">
                <i class="fas ${icon}"></i>
                ${text}
            </div>`;
        }
        
        // ============================================================================
        // CHART RENDERING
        // ============================================================================
        
        function renderDivisionChart(divisions) {
            dashDebugger.debug('Rendering division chart', { divisions: divisions.length }, 'render');
            
            const ctx = document.getElementById('divisionChart').getContext('2d');
            
            if (!divisions || divisions.length === 0) {
                ctx.font = '14px Inter';
                ctx.fillStyle = '#757575';
                ctx.textAlign = 'center';
                ctx.fillText('No division data available', ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }
            
            // Destroy existing chart if any
            if (charts.division) {
                charts.division.destroy();
            }
            
            const labels = divisions.map(d => d.name);
            const allocated = divisions.map(d => d.allocated);
            const spent = divisions.map(d => d.spent);
            const available = divisions.map(d => d.available);
            
            charts.division = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Allocated',
                            data: allocated,
                            backgroundColor: 'rgba(19, 56, 31, 0.2)',
                            borderColor: 'rgba(19, 56, 31, 1)',
                            borderWidth: 2
                        },
                        {
                            label: 'Spent',
                            data: spent,
                            backgroundColor: 'rgba(255, 152, 0, 0.2)',
                            borderColor: 'rgba(255, 152, 0, 1)',
                            borderWidth: 2
                        },
                        {
                            label: 'Available',
                            data: available,
                            backgroundColor: 'rgba(33, 150, 243, 0.2)',
                            borderColor: 'rgba(33, 150, 243, 1)',
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': $' + context.raw.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // ============================================================================
        // TABLE RENDERING
        // ============================================================================
        
        function renderDivisionTable(divisions) {
            dashDebugger.debug('Rendering division table', { divisions: divisions.length }, 'render');

            const tbody = document.querySelector('#divisionTable tbody');
            tbody.innerHTML = '';

            if (!divisions || divisions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No division data available</td></tr>';
                return;
            }

            divisions.forEach(division => {
                const row = document.createElement('tr');
                // Add data attributes for sorting
                row.dataset.name = division.name;
                row.dataset.allocated = division.allocated;
                row.dataset.spent = division.spent;
                row.dataset.encumbered = division.encumbered;
                row.dataset.available = division.available;
                row.dataset.utilization = division.utilization;

                row.innerHTML = `
                    <td data-col="name"><strong>${division.name}</strong></td>
                    <td data-col="allocated">$${division.allocated.toLocaleString()}</td>
                    <td data-col="spent">$${division.spent.toLocaleString()}</td>
                    <td data-col="encumbered">$${division.encumbered.toLocaleString()}</td>
                    <td data-col="available">$${division.available.toLocaleString()}</td>
                    <td data-col="utilization">${division.utilization}%</td>
                    <td data-col="status">
                        <span class="status-badge ${getUtilizationStatus(division.utilization)}">
                            ${getUtilizationStatusLabel(division.utilization)}
                        </span>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function getUtilizationStatusLabel(utilization) {
            if (utilization >= 90) return 'Over Budget';
            if (utilization >= 75) return 'Monitor';
            return 'On Track';
        }
        
        // Store full transaction data for filtering
        let allTransactions = [];

        function renderTransactions(transactions, applyCurrentFilters = false) {
            dashDebugger.debug('Rendering transactions', { count: transactions.length }, 'render');

            // Store for filtering
            allTransactions = transactions || [];

            const tbody = document.querySelector('#transactionsTable tbody');
            tbody.innerHTML = '';

            if (!transactions || transactions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No recent transactions</td></tr>';
                updateFilterCount('transactionsTable', 0, 0);
                return;
            }

            // Apply filters if requested
            let displayTransactions = applyCurrentFilters ? getFilteredTransactions(transactions) : transactions;

            displayTransactions.forEach(transaction => {
                const row = document.createElement('tr');
                // Add data attributes for sorting and filtering
                row.dataset.date = transaction.date;
                row.dataset.id = transaction.transactionId;
                row.dataset.division = transaction.division;
                row.dataset.department = transaction.department;
                row.dataset.vendor = transaction.vendor;
                row.dataset.amount = transaction.amount;
                row.dataset.status = transaction.status;

                row.innerHTML = `
                    <td data-col="date">${formatDate(transaction.date)}</td>
                    <td data-col="id"><code>${transaction.transactionId}</code></td>
                    <td data-col="division">${transaction.division}</td>
                    <td data-col="department">${transaction.department}</td>
                    <td data-col="vendor">${transaction.vendor}</td>
                    <td data-col="description">${transaction.description}</td>
                    <td data-col="amount">$${transaction.amount.toLocaleString()}</td>
                    <td data-col="status">
                        <span class="status-badge ${transaction.status.toLowerCase()}">
                            ${transaction.status}
                        </span>
                    </td>
                `;
                tbody.appendChild(row);
            });

            updateFilterCount('transactionsTable', displayTransactions.length, transactions.length);
        }
        
        // ============================================================================
        // UTILITY FUNCTIONS
        // ============================================================================
        
        function getUtilizationStatus(utilization) {
            if (utilization >= 90) return 'rejected';
            if (utilization >= 75) return 'pending';
            return 'approved';
        }
        
        function formatDate(date) {
            if (!date) return '';
            const d = new Date(date);
            return d.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        // ============================================================================
        // TABLE SORTING FUNCTIONS
        // ============================================================================

        function sortTable(tableId, column, dataType) {
            const table = document.getElementById(tableId);
            if (!table) return;

            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));

            // Determine sort direction
            const currentCol = table.dataset.sortCol;
            const currentDir = table.dataset.sortDir;
            const isAscending = currentCol === column ? currentDir !== 'asc' : true;

            // Sort rows
            rows.sort((a, b) => {
                const aVal = a.dataset[column];
                const bVal = b.dataset[column];

                let comparison = 0;
                switch (dataType) {
                    case 'number':
                        comparison = parseFloat(aVal || 0) - parseFloat(bVal || 0);
                        break;
                    case 'currency':
                        comparison = parseFloat(aVal || 0) - parseFloat(bVal || 0);
                        break;
                    case 'date':
                        comparison = new Date(aVal || 0) - new Date(bVal || 0);
                        break;
                    default: // string
                        comparison = (aVal || '').localeCompare(bVal || '');
                }

                return isAscending ? comparison : -comparison;
            });

            // Update table state
            table.dataset.sortCol = column;
            table.dataset.sortDir = isAscending ? 'asc' : 'desc';

            // Re-append sorted rows
            rows.forEach(row => tbody.appendChild(row));

            // Update sort indicators
            updateSortIndicators(tableId, column, isAscending);

            dashDebugger.debug('Table sorted', { tableId, column, direction: isAscending ? 'asc' : 'desc' }, 'ui');
        }

        function updateSortIndicators(tableId, column, isAscending) {
            const table = document.getElementById(tableId);
            if (!table) return;

            // Remove all sort indicators
            table.querySelectorAll('th.sortable').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
            });

            // Add indicator to sorted column
            const sortedTh = table.querySelector(`th[data-sort="${column}"]`);
            if (sortedTh) {
                sortedTh.classList.add(isAscending ? 'sort-asc' : 'sort-desc');
            }
        }

        // ============================================================================
        // TABLE FILTERING FUNCTIONS
        // ============================================================================

        function getFilteredTransactions(transactions) {
            const division = document.getElementById('txnFilterDivision')?.value;
            const status = document.getElementById('txnFilterStatus')?.value;
            const dateStart = document.getElementById('txnFilterDateStart')?.value;
            const dateEnd = document.getElementById('txnFilterDateEnd')?.value;

            return transactions.filter(t => {
                if (division && t.division !== division) return false;
                if (status && t.status !== status) return false;
                if (dateStart) {
                    const txnDate = new Date(t.date);
                    const startDate = new Date(dateStart);
                    if (txnDate < startDate) return false;
                }
                if (dateEnd) {
                    const txnDate = new Date(t.date);
                    const endDate = new Date(dateEnd);
                    endDate.setHours(23, 59, 59); // Include full end day
                    if (txnDate > endDate) return false;
                }
                return true;
            });
        }

        function applyTransactionFilters() {
            renderTransactions(allTransactions, true);
            dashDebugger.debug('Transaction filters applied', null, 'ui');
        }

        function clearTransactionFilters() {
            document.getElementById('txnFilterDivision').value = '';
            document.getElementById('txnFilterStatus').value = '';
            document.getElementById('txnFilterDateStart').value = '';
            document.getElementById('txnFilterDateEnd').value = '';
            renderTransactions(allTransactions, false);
            dashDebugger.debug('Transaction filters cleared', null, 'ui');
        }

        function updateFilterCount(tableId, shown, total) {
            const countEl = document.getElementById(tableId === 'transactionsTable' ? 'txnFilterCount' : 'filterCount');
            if (countEl) {
                if (shown === total) {
                    countEl.textContent = `Showing all ${total} records`;
                } else {
                    countEl.textContent = `Showing ${shown} of ${total} records`;
                }
            }
        }

        // ============================================================================
        // ROLE-BASED DATA FILTERING
        // ============================================================================

        function filterDataForRole(data, role, division, department) {
            if (!role || role === 'executive') {
                return data;  // Executive sees everything
            }

            const filtered = JSON.parse(JSON.stringify(data));  // Deep clone

            if (role === 'principal' && division) {
                // Principal sees only their division
                filtered.divisionSummary = data.divisionSummary.filter(d =>
                    d.division === division || d.code === division
                );
                filtered.transactions = data.transactions.filter(t =>
                    t.division === division
                );

                // Recalculate KPIs from filtered division
                const divData = filtered.divisionSummary[0];
                if (divData && filtered.kpis) {
                    filtered.kpis = filtered.kpis.map(kpi => {
                        switch (kpi.id) {
                            case 'total_budget':
                                return { ...kpi, value: divData.allocated, description: `${divData.name} allocated budget` };
                            case 'ytd_spending':
                                const pct = Math.round((divData.spent / divData.allocated) * 100);
                                return { ...kpi, value: divData.spent, description: `${pct}% of division budget` };
                            case 'budget_utilization':
                                return { ...kpi, value: divData.utilization, description: getDivisionPaceDescription(divData.utilization) };
                            case 'pending_approvals':
                                const pending = filtered.transactions.filter(t => t.status === 'Pending').length;
                                return { ...kpi, value: pending };
                            default:
                                return kpi;
                        }
                    });
                }
            }

            if (role === 'department_head' && division && department) {
                // Department head sees only their department
                filtered.divisionSummary = data.divisionSummary.filter(d =>
                    d.division === division || d.code === division
                );
                filtered.transactions = data.transactions.filter(t =>
                    t.division === division && t.department === department
                );

                // Recalculate KPIs from filtered transactions
                const totalSpent = filtered.transactions.reduce((sum, t) => sum + (t.amount || 0), 0);
                const pending = filtered.transactions.filter(t => t.status === 'Pending').length;

                if (filtered.kpis) {
                    filtered.kpis = filtered.kpis.map(kpi => {
                        switch (kpi.id) {
                            case 'total_budget':
                                return { ...kpi, value: 100000, description: `${department} department budget` };
                            case 'ytd_spending':
                                return { ...kpi, value: totalSpent, description: `${department} spending` };
                            case 'budget_utilization':
                                const util = Math.round((totalSpent / 100000) * 100);
                                return { ...kpi, value: util, description: getDivisionPaceDescription(util) };
                            case 'pending_approvals':
                                return { ...kpi, value: pending };
                            default:
                                return kpi;
                        }
                    });
                }
            }

            return filtered;
        }

        function getDivisionPaceDescription(utilization) {
            // Based on current fiscal month, determine if on track
            const now = new Date();
            const month = now.getMonth();
            const fiscalMonth = month >= 6 ? month - 6 : month + 6;

            // Expected milestones (matching backend)
            const milestones = {
                0: 5, 1: 30, 2: 45, 3: 52, 4: 58, 5: 65,
                6: 72, 7: 78, 8: 84, 9: 90, 10: 95, 11: 100
            };

            const expected = milestones[fiscalMonth] || 50;
            const tolerance = 12;

            if (utilization >= expected - tolerance && utilization <= expected + tolerance) {
                return 'On track for fiscal year';
            } else if (utilization > expected + tolerance) {
                return 'Over pace - monitor spending';
            } else {
                return 'Under pace - spending available';
            }
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('collapsed');
            dashDebugger.debug('Sidebar toggled', null, 'ui');
        }
        
        function switchTab(tabName) {
            dashDebugger.debug('Switching tab', { from: currentTab, to: tabName }, 'ui');

            // Update active nav item
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.toggle('active', item.dataset.tab === tabName);
            });

            // Update active tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.toggle('active', content.id === tabName + 'Tab');
            });

            // Update page title
            const titles = {
                overview: 'Dashboard Overview',
                transactions: 'Transactions',
                tac: 'TAC Calculator',
                reports: 'Reports',
                analytics: 'Analytics'
            };
            document.getElementById('pageTitle').textContent = titles[tabName] || 'Dashboard';

            // Render tab-specific content
            if (tabName === 'tac') {
                renderTACTab();
            } else if (tabName === 'analytics') {
                renderAnalyticsTab();
            }

            currentTab = tabName;
        }
        
        function refreshDashboard() {
            dashDebugger.log(' Refreshing dashboard...', null, 'action');
            if (!isLoading) {
                loadDashboard();
            }
        }
        
        function exportDashboard() {
            dashDebugger.log(' Exporting dashboard...', null, 'action');

            // Get current active tab
            const activeTab = document.querySelector('.tab-content.active');
            const tabId = activeTab ? activeTab.id : 'overviewTab';

            let data = [];
            let filename = 'dashboard-export';

            if (tabId === 'overviewTab' && dashboardData?.divisionSummary) {
                data = dashboardData.divisionSummary.map(d => ({
                    Division: d.name,
                    Allocated: d.allocated,
                    Spent: d.spent,
                    Encumbered: d.encumbered,
                    Available: d.available,
                    Utilization: d.utilization + '%'
                }));
                filename = 'budget-overview';
            } else if (tabId === 'transactionsTab' && dashboardData?.transactions) {
                data = dashboardData.transactions.map(t => ({
                    Date: new Date(t.date).toLocaleDateString(),
                    ID: t.transactionId,
                    Division: t.division,
                    Department: t.department,
                    Vendor: t.vendor,
                    Description: t.description,
                    Amount: '$' + t.amount.toLocaleString(),
                    Status: t.status
                }));
                filename = 'transactions';
            } else if (tabId === 'tacTab' && dashboardData?.tacSummary) {
                const tac = dashboardData.tacSummary;
                data = [
                    { Category: 'Technology', Allocated: tac.byCategory?.technology?.allocated || 0, Spent: tac.byCategory?.technology?.spent || 0 },
                    { Category: 'Activities', Allocated: tac.byCategory?.activities?.allocated || 0, Spent: tac.byCategory?.activities?.spent || 0 },
                    { Category: 'Curriculum', Allocated: tac.byCategory?.consumables?.allocated || 0, Spent: tac.byCategory?.consumables?.spent || 0 }
                ];
                filename = 'tac-summary';
            } else {
                alert('No data available to export for this view');
                return;
            }

            downloadCSV(data, filename);
        }

        function downloadCSV(data, filename) {
            if (!data || data.length === 0) {
                alert('No data to export');
                return;
            }

            const headers = Object.keys(data[0]);
            const csvContent = [
                headers.join(','),
                ...data.map(row => headers.map(h => {
                    let val = row[h];
                    if (typeof val === 'string' && val.includes(',')) {
                        val = '"' + val + '"';
                    }
                    return val;
                }).join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `${filename}-${new Date().toISOString().split('T')[0]}.csv`;
            link.click();

            dashDebugger.log(' Export completed: ' + filename, null, 'action');
        }

        // ============================================================================
        // TAC GRADE-LEVEL TRACKING
        // ============================================================================

        // TAC Grade Order for display
        const TAC_GRADE_ORDER = ['Infants', 'PK2', 'PK3', 'PK4', 'K', '1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12'];

        // TAC Grade data storage
        let tacGradeData = null;
        let tacEnrollmentData = {};

        function renderTACTab() {
            // Load TAC grade data from backend
            loadTACGradeData();
        }

        async function loadTACGradeData() {
            try {
                // Call backend to get TAC by grade data
                const result = await new Promise((resolve, reject) => {
                    google.script.run
                        .withSuccessHandler(resolve)
                        .withFailureHandler(reject)
                        .getTACByGradeData();
                });
                tacGradeData = result;
                tacEnrollmentData = result.enrollment || {};

                // Render all TAC components
                renderTACKPIs(result);
                renderTACGradeTable(result);
                renderEnrollmentEditor();
                renderStepUpTracker(result.stepUp);
                renderTACCategoryChart(dashboardData?.tacSummary);
                renderTACCategoryBreakdown(dashboardData?.tacSummary);
            } catch (error) {
                console.error('Error loading TAC data:', error);
                // Use mock data for demo
                renderTACWithMockData();
            }
        }

        function renderTACWithMockData() {
            // Mock data for demo mode
            const mockData = {
                grades: TAC_GRADE_ORDER.map((grade, i) => ({
                    grade: grade,
                    division: i < 4 ? 'KK' : i < 10 ? 'LS' : i < 13 ? 'MS' : 'US',
                    enrollment: Math.floor(Math.random() * 50) + 20,
                    tacFee: 850 + (i * 30),
                    tacBudgeted: 0,
                    tacSpent: Math.floor(Math.random() * 10000) + 5000,
                    variance: 0,
                    variancePercent: 0,
                    curricular: Math.floor(Math.random() * 3000),
                    fieldTrip: Math.floor(Math.random() * 2000),
                    techCost: Math.floor(Math.random() * 2000),
                    status: 'on_track'
                })),
                totals: { enrollment: 750, tacBudgeted: 825000, tacSpent: 340000, variance: 485000 },
                stepUp: {
                    quarterlyExpected: 1500000,
                    currentQuarter: 2,
                    quarters: {
                        q1: { expected: 1500000, received: 1500000 },
                        q2: { expected: 1500000, received: 1425000 },
                        q3: { expected: 1500000, received: 0 },
                        q4: { expected: 1500000, received: 0 }
                    }
                }
            };

            // Calculate budgeted and variance
            mockData.grades.forEach(g => {
                g.tacBudgeted = g.enrollment * g.tacFee;
                g.variance = g.tacBudgeted - g.tacSpent;
                g.variancePercent = g.tacBudgeted > 0 ? Math.round((g.variance / g.tacBudgeted) * 100) : 0;
                g.status = g.variancePercent < -10 ? 'over_budget' : g.variancePercent < 0 ? 'warning' : 'on_track';
            });

            tacGradeData = mockData;
            tacEnrollmentData = {};
            mockData.grades.forEach(g => tacEnrollmentData[g.grade] = g.enrollment);

            renderTACKPIs({ totals: mockData.totals });
            renderTACGradeTable(mockData);
            renderEnrollmentEditor();
            renderStepUpTracker(mockData.stepUp);
            renderTACCategoryChart(dashboardData?.tacSummary);
            renderTACCategoryBreakdown(dashboardData?.tacSummary);
        }

        function renderTACKPIs(data) {
            const grid = document.getElementById('tacKpiGrid');
            if (!grid) return;

            const totals = data?.totals || { enrollment: 750, tacBudgeted: 825000, tacSpent: 340000, variance: 485000 };
            const utilization = totals.tacBudgeted > 0 ? Math.round((totals.tacSpent / totals.tacBudgeted) * 100) : 0;

            const kpis = [
                { label: 'Total Enrollment', value: totals.enrollment, format: 'number', description: 'Students across all grades' },
                { label: 'TAC Budgeted', value: totals.tacBudgeted, format: 'currency', description: 'Enrollment  TAC fee' },
                { label: 'TAC Spent', value: totals.tacSpent, format: 'currency', description: `${utilization}% utilized` },
                { label: 'TAC Available', value: totals.variance, format: 'currency', description: 'Remaining balance' }
            ];

            grid.innerHTML = '';
            kpis.forEach(kpi => {
                const card = createKPICard(kpi);
                grid.appendChild(card);
            });
        }

        function renderTACGradeTable(data) {
            const tbody = document.getElementById('tacGradeTableBody');
            const tfoot = document.getElementById('tacGradeTableFooter');
            if (!tbody) return;

            const grades = data?.grades || [];
            const filter = document.getElementById('tacDivisionFilter')?.value || 'ALL';

            const filteredGrades = filter === 'ALL' ? grades : grades.filter(g => g.division === filter);

            tbody.innerHTML = filteredGrades.map(g => {
                const statusClass = g.status === 'over_budget' ? 'status-rejected' :
                                   g.status === 'warning' ? 'status-pending' :
                                   g.status === 'under_utilized' ? 'status-processing' : 'status-approved';
                const statusText = g.status === 'over_budget' ? 'Over' :
                                  g.status === 'warning' ? 'Warning' :
                                  g.status === 'under_utilized' ? 'Under' : 'On Track';
                const varianceColor = g.variance < 0 ? '#dc3545' : g.variance > 0 ? 'var(--primary-green)' : 'inherit';

                return `
                    <tr>
                        <td><strong>${g.grade}</strong></td>
                        <td>${g.division}</td>
                        <td>${g.enrollment}</td>
                        <td>$${g.tacFee?.toLocaleString()}</td>
                        <td>$${g.tacBudgeted?.toLocaleString()}</td>
                        <td>$${g.tacSpent?.toLocaleString()}</td>
                        <td style="color: ${varianceColor}; font-weight: 500;">
                            ${g.variance >= 0 ? '+' : ''}$${g.variance?.toLocaleString()}
                            <span style="font-size: 11px; opacity: 0.8;">(${g.variancePercent}%)</span>
                        </td>
                        <td>$${g.curricular?.toLocaleString()}</td>
                        <td>$${g.fieldTrip?.toLocaleString()}</td>
                        <td>$${g.techCost?.toLocaleString()}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                    </tr>
                `;
            }).join('');

            // Calculate filtered totals
            const totals = filteredGrades.reduce((acc, g) => ({
                enrollment: acc.enrollment + (g.enrollment || 0),
                tacBudgeted: acc.tacBudgeted + (g.tacBudgeted || 0),
                tacSpent: acc.tacSpent + (g.tacSpent || 0),
                variance: acc.variance + (g.variance || 0),
                curricular: acc.curricular + (g.curricular || 0),
                fieldTrip: acc.fieldTrip + (g.fieldTrip || 0),
                techCost: acc.techCost + (g.techCost || 0)
            }), { enrollment: 0, tacBudgeted: 0, tacSpent: 0, variance: 0, curricular: 0, fieldTrip: 0, techCost: 0 });

            if (tfoot) {
                const varianceColor = totals.variance < 0 ? '#dc3545' : 'var(--primary-green)';
                tfoot.innerHTML = `
                    <tr style="background: var(--bg-secondary); font-weight: 600;">
                        <td colspan="2">TOTALS</td>
                        <td>${totals.enrollment.toLocaleString()}</td>
                        <td>-</td>
                        <td>$${totals.tacBudgeted.toLocaleString()}</td>
                        <td>$${totals.tacSpent.toLocaleString()}</td>
                        <td style="color: ${varianceColor};">${totals.variance >= 0 ? '+' : ''}$${totals.variance.toLocaleString()}</td>
                        <td>$${totals.curricular.toLocaleString()}</td>
                        <td>$${totals.fieldTrip.toLocaleString()}</td>
                        <td>$${totals.techCost.toLocaleString()}</td>
                        <td>-</td>
                    </tr>
                `;
            }
        }

        function filterTACByDivision() {
            if (tacGradeData) {
                renderTACGradeTable(tacGradeData);
            }
        }

        function renderEnrollmentEditor() {
            const container = document.getElementById('enrollmentEditor');
            if (!container) return;

            const inputsHTML = TAC_GRADE_ORDER.map(grade => `
                <div style="text-align: center;">
                    <label style="display: block; font-size: 12px; font-weight: 600; margin-bottom: 4px;">${grade}</label>
                    <input type="number" id="enrollment_${grade}" value="${tacEnrollmentData[grade] || 0}" min="0"
                           style="width: 70px; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 14px; text-align: center;"
                           onchange="updateEnrollmentPreview()">
                </div>
            `).join('');

            container.querySelector('div')?.remove();
            container.insertAdjacentHTML('afterbegin', `<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 12px; margin-bottom: 16px;">${inputsHTML}</div>`);
        }

        function toggleEnrollmentEditor() {
            const editor = document.getElementById('enrollmentEditor');
            const icon = document.getElementById('enrollmentToggleIcon');
            if (editor) {
                const isHidden = editor.style.display === 'none';
                editor.style.display = isHidden ? 'block' : 'none';
                if (icon) {
                    icon.className = isHidden ? 'fas fa-chevron-up' : 'fas fa-chevron-down';
                }
            }
        }

        function updateEnrollmentPreview() {
            // Update local enrollment data
            TAC_GRADE_ORDER.forEach(grade => {
                const input = document.getElementById(`enrollment_${grade}`);
                if (input) {
                    tacEnrollmentData[grade] = parseInt(input.value) || 0;
                }
            });
        }

        async function saveTACEnrollment() {
            const statusDiv = document.getElementById('enrollmentSaveStatus');
            updateEnrollmentPreview();

            try {
                statusDiv.style.display = 'block';
                statusDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
                statusDiv.style.color = 'var(--text-secondary)';

                const result = await new Promise((resolve, reject) => {
                    google.script.run
                        .withSuccessHandler(resolve)
                        .withFailureHandler(reject)
                        .saveEnrollmentData(tacEnrollmentData);
                });

                statusDiv.innerHTML = '<i class="fas fa-check-circle"></i> Enrollment saved successfully!';
                statusDiv.style.color = 'var(--primary-green)';

                // Reload TAC data
                setTimeout(() => loadTACGradeData(), 1000);
            } catch (error) {
                statusDiv.innerHTML = '<i class="fas fa-exclamation-circle"></i> Error saving: ' + error.message;
                statusDiv.style.color = '#dc3545';
            }
        }

        function resetEnrollmentToDefaults() {
            TAC_GRADE_ORDER.forEach(grade => {
                const input = document.getElementById(`enrollment_${grade}`);
                if (input) input.value = '0';
            });
            tacEnrollmentData = {};
        }

        function exportTACData() {
            if (!tacGradeData?.grades) return;

            const data = tacGradeData.grades.map(g => ({
                Grade: g.grade,
                Division: g.division,
                Enrollment: g.enrollment,
                'TAC Fee': g.tacFee,
                'TAC Budgeted': g.tacBudgeted,
                'TAC Spent': g.tacSpent,
                Variance: g.variance,
                'Variance %': g.variancePercent,
                Curricular: g.curricular,
                'Field Trips': g.fieldTrip,
                'Tech Cost': g.techCost,
                Status: g.status
            }));

            downloadCSV(data, `tac-by-grade-${new Date().toISOString().split('T')[0]}`);
        }

        function renderStepUpTracker(stepUpData) {
            const summaryContainer = document.getElementById('stepUpSummary');
            const quartersContainer = document.getElementById('stepUpQuarters');
            if (!summaryContainer || !quartersContainer) return;

            const stepUp = stepUpData || {
                quarterlyExpected: 1500000,
                currentQuarter: 2,
                quarters: {
                    q1: { expected: 1500000, received: 1500000 },
                    q2: { expected: 1500000, received: 1425000 },
                    q3: { expected: 1500000, received: 0 },
                    q4: { expected: 1500000, received: 0 }
                }
            };

            const ytdExpected = stepUp.quarterlyExpected * stepUp.currentQuarter;
            const ytdReceived = Object.values(stepUp.quarters).reduce((sum, q) => sum + (q.received || 0), 0);

            summaryContainer.innerHTML = `
                <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 12px; color: var(--text-secondary);">Quarterly Expected</div>
                    <div style="font-size: 24px; font-weight: 700; color: var(--primary-green);">$${stepUp.quarterlyExpected.toLocaleString()}</div>
                </div>
                <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 12px; color: var(--text-secondary);">YTD Expected</div>
                    <div style="font-size: 24px; font-weight: 700;">$${ytdExpected.toLocaleString()}</div>
                </div>
                <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 12px; color: var(--text-secondary);">YTD Received</div>
                    <div style="font-size: 24px; font-weight: 700; color: ${ytdReceived >= ytdExpected ? 'var(--primary-green)' : '#f0ad4e'};">$${ytdReceived.toLocaleString()}</div>
                </div>
                <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 12px; color: var(--text-secondary);">Current Quarter</div>
                    <div style="font-size: 24px; font-weight: 700;">Q${stepUp.currentQuarter}</div>
                </div>
            `;

            quartersContainer.innerHTML = ['q1', 'q2', 'q3', 'q4'].map((q, i) => {
                const quarter = stepUp.quarters[q] || { expected: 0, received: 0 };
                const percent = quarter.expected > 0 ? Math.min(100, Math.round((quarter.received / quarter.expected) * 100)) : 0;
                const isCurrent = i + 1 === stepUp.currentQuarter;
                const isPast = i + 1 < stepUp.currentQuarter;

                return `
                    <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px; ${isCurrent ? 'border: 2px solid var(--primary-green);' : ''}">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="font-weight: 600;">Q${i + 1}</span>
                            <span style="font-size: 12px; color: var(--text-secondary);">${isCurrent ? 'Current' : isPast ? 'Complete' : 'Upcoming'}</span>
                        </div>
                        <div style="height: 8px; background: #e0e0e0; border-radius: 4px; overflow: hidden; margin-bottom: 8px;">
                            <div style="height: 100%; width: ${percent}%; background: ${percent >= 100 ? 'var(--primary-green)' : percent > 0 ? '#f0ad4e' : '#e0e0e0'}; border-radius: 4px;"></div>
                        </div>
                        <div style="font-size: 12px; display: flex; justify-content: space-between;">
                            <span>$${quarter.received.toLocaleString()}</span>
                            <span style="color: var(--text-secondary);">/ $${quarter.expected.toLocaleString()}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderTACCategoryChart(tac) {
            const ctx = document.getElementById('tacCategoryChart');
            if (!ctx) return;

            const categories = tac?.byCategory || {
                technology: { allocated: 440000, spent: 187000 },
                activities: { allocated: 200000, spent: 85000 },
                consumables: { allocated: 160000, spent: 68000 }
            };

            if (charts.tacCategory) {
                charts.tacCategory.destroy();
            }

            charts.tacCategory = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Technology (55%)', 'Activities (25%)', 'Curriculum (20%)'],
                    datasets: [{
                        data: [
                            categories.technology?.allocated || 440000,
                            categories.activities?.allocated || 200000,
                            categories.consumables?.allocated || 160000
                        ],
                        backgroundColor: ['#13381f', '#2d6a4f', '#74c69d'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': $' + context.raw.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderTACCategoryBreakdown(tac) {
            const container = document.getElementById('tacCategoryBreakdown');
            if (!container) return;

            const categories = [
                { name: 'Technology', key: 'technology', percent: 55, icon: 'fa-laptop', color: '#13381f' },
                { name: 'Activities', key: 'activities', percent: 25, icon: 'fa-bus', color: '#2d6a4f' },
                { name: 'Curriculum', key: 'consumables', percent: 20, icon: 'fa-book', color: '#74c69d' }
            ];

            container.innerHTML = categories.map(cat => {
                const data = tac?.byCategory?.[cat.key] || { allocated: 0, spent: 0 };
                const utilization = data.allocated > 0 ? Math.round((data.spent / data.allocated) * 100) : 0;
                const available = data.allocated - data.spent;

                return `
                    <div style="background: var(--bg-secondary); border-radius: 8px; padding: 12px; margin-bottom: 8px;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                            <div style="width: 32px; height: 32px; background: ${cat.color}20; border-radius: 6px; display: flex; align-items: center; justify-content: center;">
                                <i class="fas ${cat.icon}" style="color: ${cat.color}; font-size: 14px;"></i>
                            </div>
                            <div>
                                <div style="font-weight: 600; font-size: 13px;">${cat.name}</div>
                                <div style="font-size: 11px; color: var(--text-secondary);">${cat.percent}%</div>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px; font-size: 12px;">
                            <div><span style="color: var(--text-secondary);">Spent:</span> <strong>$${data.spent.toLocaleString()}</strong></div>
                            <div><span style="color: var(--text-secondary);">Avail:</span> <strong style="color: var(--primary-green);">$${available.toLocaleString()}</strong></div>
                        </div>
                        <div style="margin-top: 8px;">
                            <div style="height: 4px; background: #e0e0e0; border-radius: 2px; overflow: hidden;">
                                <div style="height: 100%; width: ${utilization}%; background: ${cat.color};"></div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ============================================================================
        // REPORTS RENDERING
        // ============================================================================

        function generateReport(reportType) {
            dashDebugger.log('Generating report: ' + reportType, null, 'action');

            const division = document.getElementById('reportDivision')?.value || 'all';
            const status = document.getElementById('reportStatus')?.value || 'all';
            const dateRange = document.getElementById('reportDateRange')?.value || 'ytd';
            const format = document.getElementById('reportFormat')?.value || 'csv';

            let data = [];
            let filename = '';
            const dateFilter = getReportDateFilter(dateRange);

            switch (reportType) {
                case 'budget':
                    data = generateBudgetReport(division);
                    filename = `budget-summary-${dateRange}`;
                    break;
                case 'transactions':
                    data = generateTransactionReport(division, status, dateFilter);
                    filename = `transactions-${dateRange}`;
                    break;
                case 'tac':
                    data = generateTACReport(division);
                    filename = `tac-report-${dateRange}`;
                    break;
                case 'admin':
                    generateBackendReport('admin', { division, status, dateFilter });
                    return;
                case 'curriculum':
                    generateBackendReport('curriculum', { division, status, dateFilter });
                    return;
                case 'fieldtrip':
                    generateBackendReport('fieldtrip', { division, status, dateFilter });
                    return;
                case 'supply':
                    const aggregateLevel = document.getElementById('supplyAggregateLevel')?.value || 'teacher';
                    generateBackendReport('supply', { division, status, dateFilter, aggregateLevel });
                    return;
            }

            // Show preview
            showReportPreview(data, reportType);

            // Download
            if (format === 'csv') {
                downloadCSV(data, filename);
            } else {
                downloadJSON(data, filename);
            }
        }

        // Generate supply report with aggregation options
        function generateSupplyReportWithOptions() {
            generateReport('supply');
        }

        // Generate reports via backend API
        async function generateBackendReport(reportType, filters) {
            const format = document.getElementById('reportFormat')?.value || 'csv';
            const dateRange = document.getElementById('reportDateRange')?.value || 'ytd';

            // Show loading state
            const preview = document.getElementById('reportPreview');
            if (preview) {
                preview.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 32px; color: var(--primary-green);"></i>
                        <p style="margin-top: 12px; color: var(--text-secondary);">Generating ${reportType} report...</p>
                    </div>
                `;
            }

            try {
                const result = await new Promise((resolve, reject) => {
                    google.script.run
                        .withSuccessHandler(resolve)
                        .withFailureHandler(reject)
                        .getReportData(reportType, filters);
                });

                if (result.success && result.data) {
                    const reportData = result.data;
                    let exportData = [];
                    let filename = `${reportType}-report-${dateRange}`;

                    // Format data for export based on report type
                    switch (reportType) {
                        case 'admin':
                            exportData = formatAdminReportData(reportData);
                            break;
                        case 'curriculum':
                            exportData = formatCurriculumReportData(reportData);
                            break;
                        case 'fieldtrip':
                            exportData = formatFieldTripReportData(reportData);
                            break;
                        case 'supply':
                            exportData = formatSupplyReportData(reportData, filters.aggregateLevel);
                            filename = `supply-by-${filters.aggregateLevel}-${dateRange}`;
                            break;
                    }

                    showReportPreview(exportData, reportType);

                    if (format === 'csv') {
                        downloadCSV(exportData, filename);
                    } else {
                        downloadJSON(exportData, filename);
                    }
                } else {
                    throw new Error(result.error || 'Failed to generate report');
                }
            } catch (error) {
                console.error('Report generation error:', error);
                if (preview) {
                    preview.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #dc3545;">
                            <i class="fas fa-exclamation-circle" style="font-size: 32px;"></i>
                            <p style="margin-top: 12px;">Error generating report: ${error.message}</p>
                        </div>
                    `;
                }
            }
        }

        function formatAdminReportData(reportData) {
            if (!reportData.transactions) return [];
            return reportData.transactions.map(t => ({
                Date: t.date ? new Date(t.date).toLocaleDateString() : '',
                'Transaction ID': t.transactionId,
                Department: t.department,
                Vendor: t.vendor,
                Description: t.description,
                Amount: `$${(t.amount || 0).toLocaleString()}`,
                Status: t.status,
                Requestor: t.requestor
            }));
        }

        function formatCurriculumReportData(reportData) {
            if (!reportData.transactions) return [];
            return reportData.transactions.map(t => ({
                Date: t.date ? new Date(t.date).toLocaleDateString() : '',
                'Transaction ID': t.transactionId,
                Division: t.division,
                Department: t.department,
                Vendor: t.vendor,
                Description: t.description,
                Amount: `$${(t.amount || 0).toLocaleString()}`,
                Status: t.status
            }));
        }

        function formatFieldTripReportData(reportData) {
            if (!reportData.transactions) return [];
            return reportData.transactions.map(t => ({
                Date: t.date ? new Date(t.date).toLocaleDateString() : '',
                Division: t.division,
                Department: t.department,
                Destination: t.description,
                Vendor: t.vendor,
                Amount: `$${(t.amount || 0).toLocaleString()}`,
                Status: t.status,
                Requestor: t.requestor
            }));
        }

        function formatSupplyReportData(reportData, aggregateLevel) {
            if (aggregateLevel === 'division' && reportData.byDivision) {
                return reportData.byDivision.map(d => ({
                    Division: d.division,
                    'Division Name': d.divisionName,
                    'Total Orders': d.amazonCount + d.warehouseCount,
                    'Amazon Orders': d.amazonCount,
                    'Warehouse Orders': d.warehouseCount,
                    'Total Amount': `$${d.totalAmount.toLocaleString()}`
                }));
            } else if (aggregateLevel === 'department' && reportData.byDepartment) {
                return reportData.byDepartment.map(d => ({
                    Department: d.department,
                    Division: d.division,
                    'Total Orders': d.amazonCount + d.warehouseCount,
                    'Amazon Orders': d.amazonCount,
                    'Warehouse Orders': d.warehouseCount,
                    'Total Amount': `$${d.totalAmount.toLocaleString()}`
                }));
            } else if (reportData.byTeacher) {
                return reportData.byTeacher.map(t => ({
                    Teacher: t.teacher,
                    Department: t.department,
                    Division: t.division,
                    'Amazon Orders': t.amazonCount,
                    'Warehouse Orders': t.warehouseCount,
                    'Total Amount': `$${t.totalAmount.toLocaleString()}`
                }));
            }
            return [];
        }

        function getReportDateFilter(range) {
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth();

            // Fiscal year starts in July
            const fyYear = currentMonth >= 6 ? currentYear : currentYear - 1;
            const fyStart = new Date(fyYear, 6, 1);  // July 1

            switch (range) {
                case 'ytd':
                    return { start: fyStart, end: now };
                case 'q1':
                    return { start: fyStart, end: new Date(fyYear, 8, 30) };  // Jul-Sep
                case 'q2':
                    return { start: new Date(fyYear, 9, 1), end: new Date(fyYear, 11, 31) };  // Oct-Dec
                case 'q3':
                    return { start: new Date(fyYear + 1, 0, 1), end: new Date(fyYear + 1, 2, 31) };  // Jan-Mar
                case 'q4':
                    return { start: new Date(fyYear + 1, 3, 1), end: new Date(fyYear + 1, 5, 30) };  // Apr-Jun
                case 'last30':
                    const d30 = new Date(now);
                    d30.setDate(d30.getDate() - 30);
                    return { start: d30, end: now };
                case 'last90':
                    const d90 = new Date(now);
                    d90.setDate(d90.getDate() - 90);
                    return { start: d90, end: now };
                default:
                    return { start: fyStart, end: now };
            }
        }

        function generateBudgetReport(division) {
            const divisions = dashboardData?.divisionSummary || [];
            let filtered = division === 'all' ? divisions : divisions.filter(d => d.division === division);

            return filtered.map(d => ({
                Division: d.name,
                'Budget Allocated': '$' + d.allocated.toLocaleString(),
                'Budget Spent': '$' + d.spent.toLocaleString(),
                'Encumbered': '$' + d.encumbered.toLocaleString(),
                'Available': '$' + d.available.toLocaleString(),
                'Utilization Rate': d.utilization + '%',
                'Status': d.utilization > 75 ? 'Warning' : 'On Track'
            }));
        }

        function generateTransactionReport(division, status, dateFilter) {
            let transactions = dashboardData?.transactions || [];

            // Apply date range filter
            if (dateFilter) {
                transactions = transactions.filter(t => {
                    const txnDate = new Date(t.date);
                    return txnDate >= dateFilter.start && txnDate <= dateFilter.end;
                });
            }

            // Apply division filter
            if (division !== 'all') {
                transactions = transactions.filter(t => t.division === division);
            }

            // Apply status filter
            if (status !== 'all') {
                transactions = transactions.filter(t => t.status.toLowerCase() === status);
            }

            return transactions.map(t => ({
                Date: new Date(t.date).toLocaleDateString(),
                'Transaction ID': t.transactionId,
                Division: t.division,
                Department: t.department,
                Vendor: t.vendor,
                Description: t.description,
                Amount: '$' + t.amount.toLocaleString(),
                Status: t.status
            }));
        }

        function generateTACReport(division) {
            const tac = dashboardData?.tacSummary || {};
            const categories = tac.byCategory || {};

            const report = [
                { Category: 'Technology', Allocation: '55%', Allocated: '$' + (categories.technology?.allocated || 0).toLocaleString(), Spent: '$' + (categories.technology?.spent || 0).toLocaleString(), Available: '$' + ((categories.technology?.allocated || 0) - (categories.technology?.spent || 0)).toLocaleString() },
                { Category: 'Activities', Allocation: '25%', Allocated: '$' + (categories.activities?.allocated || 0).toLocaleString(), Spent: '$' + (categories.activities?.spent || 0).toLocaleString(), Available: '$' + ((categories.activities?.allocated || 0) - (categories.activities?.spent || 0)).toLocaleString() },
                { Category: 'Curriculum', Allocation: '20%', Allocated: '$' + (categories.consumables?.allocated || 0).toLocaleString(), Spent: '$' + (categories.consumables?.spent || 0).toLocaleString(), Available: '$' + ((categories.consumables?.allocated || 0) - (categories.consumables?.spent || 0)).toLocaleString() }
            ];

            report.push({
                Category: 'TOTAL',
                Allocation: '100%',
                Allocated: '$' + (tac.totalAllocated || 0).toLocaleString(),
                Spent: '$' + (tac.totalSpent || 0).toLocaleString(),
                Available: '$' + (tac.totalAvailable || 0).toLocaleString()
            });

            return report;
        }

        function showReportPreview(data, reportType) {
            const preview = document.getElementById('reportPreview');
            if (!preview || !data || data.length === 0) return;

            const headers = Object.keys(data[0]);
            const displayData = data.slice(0, 5); // Show first 5 rows

            preview.innerHTML = `
                <div style="margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center;">
                    <span style="color: var(--text-secondary); font-size: 13px;">Showing ${displayData.length} of ${data.length} rows</span>
                </div>
                <div class="table-wrapper">
                    <table class="data-table">
                        <thead>
                            <tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>
                        </thead>
                        <tbody>
                            ${displayData.map(row => `
                                <tr>${headers.map(h => `<td>${row[h]}</td>`).join('')}</tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                ${data.length > 5 ? '<p style="text-align: center; color: var(--text-secondary); margin-top: 12px; font-size: 13px;">... and ' + (data.length - 5) + ' more rows in download</p>' : ''}
            `;
        }

        function downloadJSON(data, filename) {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `${filename}-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
        }

        // ============================================================================
        // ANALYTICS RENDERING (ENHANCED)
        // ============================================================================

        // Analytics data cache
        let analyticsData = null;

        function renderAnalyticsTab() {
            if (!dashboardData) {
                dashDebugger.warn('No data for analytics', null, 'render');
                return;
            }

            // Load enhanced analytics data
            loadEnhancedAnalytics();

            // Render existing charts
            renderMonthlyTrendChart();
            renderCategoricalChart();
            renderDivisionComparisonChart();
            renderHealthMetrics();
        }

        async function loadEnhancedAnalytics() {
            try {
                const result = await new Promise((resolve, reject) => {
                    google.script.run
                        .withSuccessHandler(resolve)
                        .withFailureHandler(reject)
                        .getEnhancedAnalytics();
                });
                analyticsData = result;
                renderEnhancedAnalyticsUI(result);
            } catch (error) {
                console.error('Error loading enhanced analytics:', error);
                renderEnhancedAnalyticsUI(getMockEnhancedAnalytics());
            }
        }

        function getMockEnhancedAnalytics() {
            return {
                departmentVariance: [
                    { department: 'Math', division: 'US', allocated: 25000, spent: 28500, variance: -3500, percentVariance: -14, status: 'over_budget' },
                    { department: 'Science', division: 'US', allocated: 30000, spent: 31200, variance: -1200, percentVariance: -4, status: 'warning' },
                    { department: 'English', division: 'US', allocated: 22000, spent: 19800, variance: 2200, percentVariance: 10, status: 'on_track' },
                    { department: 'Grade 3', division: 'LS', allocated: 15000, spent: 12500, variance: 2500, percentVariance: 16.7, status: 'on_track' },
                    { department: 'Grade 4', division: 'LS', allocated: 15000, spent: 8500, variance: 6500, percentVariance: 43.3, status: 'under_utilized' },
                    { department: 'Admin', division: 'AD', allocated: 50000, spent: 42000, variance: 8000, percentVariance: 16, status: 'on_track' }
                ],
                approvalMetrics: { avgHours: 18.5, medianHours: 12, maxHours: 96, pendingCount: 12, overdueCount: 3, overdueThreshold: 72 },
                costPerStudent: {
                    overall: 2800,
                    byDivision: [
                        { division: 'US', costPerStudent: 3200, enrollment: 350 },
                        { division: 'MS', costPerStudent: 2900, enrollment: 200 },
                        { division: 'LS', costPerStudent: 2600, enrollment: 300 },
                        { division: 'KK', costPerStudent: 2200, enrollment: 100 }
                    ]
                },
                stepUp: { quarterlyExpected: 1500000, ytdReceived: 2925000, currentQuarter: 2 }
            };
        }

        function renderEnhancedAnalyticsUI(data) {
            renderAnalyticsKPIs(data);
            renderDepartmentVarianceChart(data.departmentVariance);
            renderApprovalMetrics(data.approvalMetrics);
            renderCostPerStudentChart(data.costPerStudent);
        }

        function renderAnalyticsKPIs(data) {
            const grid = document.getElementById('analyticsKpiGrid');
            if (!grid) return;

            const variance = data?.departmentVariance || [];
            const totalVariance = variance.reduce((sum, d) => sum + (d.variance || 0), 0);
            const approvalMetrics = data?.approvalMetrics || { avgHours: 18, pendingCount: 12 };
            const costPerStudent = data?.costPerStudent?.overall || 2800;
            const stepUp = data?.stepUp || { ytdReceived: 2925000, currentQuarter: 2 };

            const kpis = [
                {
                    label: 'Spending Variance',
                    value: Math.abs(totalVariance),
                    format: 'currency',
                    description: totalVariance >= 0 ? 'Under budget overall' : 'Over budget overall',
                    trend: totalVariance >= 0 ? 'down' : 'up'
                },
                {
                    label: 'Avg Approval Time',
                    value: approvalMetrics.avgHours,
                    format: 'number',
                    description: `${approvalMetrics.pendingCount} pending approvals`,
                    suffix: ' hrs'
                },
                {
                    label: 'Cost Per Student',
                    value: costPerStudent,
                    format: 'currency',
                    description: 'All divisions average'
                },
                {
                    label: 'Step Up YTD',
                    value: stepUp.ytdReceived,
                    format: 'currency',
                    description: `Through Q${stepUp.currentQuarter}`
                }
            ];

            grid.innerHTML = '';
            kpis.forEach(kpi => {
                const card = createKPICard(kpi);
                grid.appendChild(card);
            });
        }

        function renderDepartmentVarianceChart(varianceData) {
            const ctx = document.getElementById('departmentVarianceChart');
            if (!ctx) return;

            const data = varianceData || getMockEnhancedAnalytics().departmentVariance;

            // Sort by variance (most over budget first)
            const sorted = [...data].sort((a, b) => a.variance - b.variance);

            if (charts.departmentVariance) {
                charts.departmentVariance.destroy();
            }

            charts.departmentVariance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sorted.map(d => d.department),
                    datasets: [{
                        label: 'Variance',
                        data: sorted.map(d => d.variance),
                        backgroundColor: sorted.map(d =>
                            d.variance < 0 ? '#dc3545' :
                            d.variance > d.allocated * 0.2 ? '#ffc107' : '#28a745'
                        ),
                        borderWidth: 0
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    const dept = sorted[context.dataIndex];
                                    return [
                                        `Variance: ${value >= 0 ? '+' : ''}$${value.toLocaleString()}`,
                                        `Allocated: $${dept.allocated.toLocaleString()}`,
                                        `Spent: $${dept.spent.toLocaleString()}`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                callback: function(value) {
                                    return (value >= 0 ? '+' : '') + '$' + (value / 1000).toFixed(0) + 'k';
                                }
                            },
                            grid: { display: true }
                        },
                        y: { grid: { display: false } }
                    }
                }
            });
        }

        function renderApprovalMetrics(metrics) {
            const container = document.getElementById('approvalMetricsGrid');
            if (!container) return;

            const data = metrics || getMockEnhancedAnalytics().approvalMetrics;

            container.innerHTML = `
                <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 28px; font-weight: 700; color: var(--primary-green);">${data.avgHours}h</div>
                    <div style="font-size: 12px; color: var(--text-secondary);">Average</div>
                </div>
                <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 28px; font-weight: 700; color: var(--primary-green);">${data.medianHours}h</div>
                    <div style="font-size: 12px; color: var(--text-secondary);">Median</div>
                </div>
                <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 28px; font-weight: 700; color: ${data.pendingCount > 10 ? '#f0ad4e' : 'var(--primary-green)'};">${data.pendingCount}</div>
                    <div style="font-size: 12px; color: var(--text-secondary);">Pending</div>
                </div>
                <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 28px; font-weight: 700; color: ${data.overdueCount > 0 ? '#dc3545' : 'var(--primary-green)'};">${data.overdueCount}</div>
                    <div style="font-size: 12px; color: var(--text-secondary);">Overdue (&gt;${data.overdueThreshold}h)</div>
                </div>
            `;
        }

        function renderCostPerStudentChart(costData) {
            const ctx = document.getElementById('costPerStudentChart');
            if (!ctx) return;

            const data = costData || getMockEnhancedAnalytics().costPerStudent;
            const divisions = data.byDivision || [];

            if (charts.costPerStudent) {
                charts.costPerStudent.destroy();
            }

            charts.costPerStudent = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: divisions.map(d => d.division),
                    datasets: [{
                        label: 'Cost Per Student',
                        data: divisions.map(d => d.costPerStudent),
                        backgroundColor: ['#13381f', '#1e5631', '#2d6a4f', '#74c69d'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const div = divisions[context.dataIndex];
                                    return [
                                        `Cost/Student: $${context.raw.toLocaleString()}`,
                                        `Enrollment: ${div.enrollment} students`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderMonthlyTrendChart() {
            const ctx = document.getElementById('monthlyTrendChart');
            if (!ctx) return;

            const trends = dashboardData?.trends?.monthly || [
                { month: 'Aug', budget: 416667, actual: 380000 },
                { month: 'Sep', budget: 416667, actual: 420000 },
                { month: 'Oct', budget: 416667, actual: 395000 },
                { month: 'Nov', budget: 416667, actual: 410000 },
                { month: 'Dec', budget: 416667, actual: 380000 },
                { month: 'Jan', budget: 416667, actual: 415000 }
            ];

            if (charts.monthlyTrend) {
                charts.monthlyTrend.destroy();
            }

            charts.monthlyTrend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: trends.map(t => t.month),
                    datasets: [
                        {
                            label: 'Budget',
                            data: trends.map(t => t.budget),
                            borderColor: '#13381f',
                            backgroundColor: 'rgba(19, 56, 31, 0.1)',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            fill: false,
                            tension: 0.3
                        },
                        {
                            label: 'Actual',
                            data: trends.map(t => t.actual),
                            borderColor: '#2d6a4f',
                            backgroundColor: 'rgba(45, 106, 79, 0.2)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': $' + context.raw.toLocaleString();
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: function(value) {
                                    return '$' + (value / 1000) + 'k';
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderCategoricalChart() {
            const ctx = document.getElementById('categoricalChart');
            if (!ctx) return;

            const categorical = dashboardData?.trends?.categorical || [
                { category: 'Technology', amount: 450000, percentage: 21.4 },
                { category: 'Curriculum', amount: 380000, percentage: 18.1 },
                { category: 'Supplies', amount: 320000, percentage: 15.2 },
                { category: 'Prof. Dev.', amount: 280000, percentage: 13.3 },
                { category: 'Facilities', amount: 240000, percentage: 11.4 },
                { category: 'Activities', amount: 220000, percentage: 10.5 },
                { category: 'Other', amount: 210000, percentage: 10.0 }
            ];

            if (charts.categorical) {
                charts.categorical.destroy();
            }

            charts.categorical = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: categorical.map(c => c.category),
                    datasets: [{
                        data: categorical.map(c => c.amount),
                        backgroundColor: ['#13381f', '#1b4332', '#2d6a4f', '#40916c', '#52b788', '#74c69d', '#95d5b2'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right', labels: { boxWidth: 12, padding: 8, font: { size: 11 } } },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const cat = categorical[context.dataIndex];
                                    return `${context.label}: $${context.raw.toLocaleString()} (${cat.percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderDivisionComparisonChart() {
            const ctx = document.getElementById('divisionComparisonChart');
            if (!ctx) return;

            const divisions = dashboardData?.divisionSummary || [];

            if (charts.divisionComparison) {
                charts.divisionComparison.destroy();
            }

            charts.divisionComparison = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: divisions.map(d => d.name),
                    datasets: [
                        {
                            label: 'Utilization %',
                            data: divisions.map(d => d.utilization),
                            backgroundColor: divisions.map(d => d.utilization > 75 ? '#e63946' : '#13381f'),
                            borderRadius: 4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'Utilization: ' + context.raw + '%';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderForecastCards() {
            const container = document.getElementById('forecastGrid');
            if (!container) return;

            const divisions = dashboardData?.divisionSummary || [];
            const monthsRemaining = 6; // Assume 6 months left in FY

            container.innerHTML = divisions.map(div => {
                const monthlyRate = div.spent / 6; // Assume 6 months elapsed
                const projected = div.spent + (monthlyRate * monthsRemaining);
                const variance = div.allocated - projected;
                const status = variance >= 0 ? 'On Track' : 'Over Budget';
                const statusColor = variance >= 0 ? 'var(--primary-green)' : '#e63946';

                return `
                    <div style="background: var(--bg-secondary); border-radius: 8px; padding: 16px;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                            <h4 style="margin: 0; font-size: 14px;">${div.name}</h4>
                            <span style="font-size: 11px; padding: 2px 8px; border-radius: 4px; background: ${statusColor}20; color: ${statusColor};">${status}</span>
                        </div>
                        <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px;">
                            Budget: $${div.allocated.toLocaleString()}
                        </div>
                        <div style="font-size: 20px; font-weight: 600; margin-bottom: 8px;">
                            $${Math.round(projected).toLocaleString()}
                        </div>
                        <div style="font-size: 12px; color: ${statusColor};">
                            ${variance >= 0 ? '' : ''} $${Math.abs(Math.round(variance)).toLocaleString()} ${variance >= 0 ? 'under' : 'over'} budget
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderHealthMetrics() {
            const container = document.getElementById('healthMetrics');
            if (!container) return;

            const health = dashboardData?.financialHealth || {
                status: 'healthy',
                metrics: {
                    cashFlow: 'positive',
                    burnRate: 'normal',
                    runway: '8 months',
                    risk: 'low'
                }
            };

            const metrics = [
                { label: 'Overall Status', value: health.status, icon: 'fa-heartbeat', color: health.status === 'healthy' ? '#13381f' : '#e63946' },
                { label: 'Cash Flow', value: health.metrics?.cashFlow || 'N/A', icon: 'fa-money-bill-wave', color: health.metrics?.cashFlow === 'positive' ? '#13381f' : '#e63946' },
                { label: 'Burn Rate', value: health.metrics?.burnRate || 'N/A', icon: 'fa-fire', color: health.metrics?.burnRate === 'normal' ? '#13381f' : '#f77f00' },
                { label: 'Risk Level', value: health.metrics?.risk || 'N/A', icon: 'fa-exclamation-triangle', color: health.metrics?.risk === 'low' ? '#13381f' : '#e63946' }
            ];

            container.innerHTML = metrics.map(m => `
                <div style="background: var(--bg-secondary); border-radius: 8px; padding: 16px; display: flex; align-items: center; gap: 12px;">
                    <div style="width: 40px; height: 40px; background: ${m.color}15; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                        <i class="fas ${m.icon}" style="color: ${m.color};"></i>
                    </div>
                    <div>
                        <div style="font-size: 12px; color: var(--text-secondary);">${m.label}</div>
                        <div style="font-weight: 600; text-transform: capitalize; color: ${m.color};">${m.value}</div>
                    </div>
                </div>
            `).join('');
        }

        function toggleChartType() {
            dashDebugger.log(' Toggling chart type...', null, 'action');
            // TODO: Implement chart type toggle
        }
        
        function showAlerts(alerts) {
            dashDebugger.log(' Showing alerts', { count: alerts.length }, 'ui');
            // TODO: Implement alerts display
        }
        
        // ============================================================================
        // DEMO DATA GENERATOR
        // ============================================================================
        
        function generateDemoData() {
            return {
                kpis: [
                    {
                        id: 'total_budget',
                        label: 'Total Annual Budget',
                        value: 5000000,
                        format: 'currency',
                        trend: 'stable',
                        description: 'FY 2024-25 allocated budget'
                    },
                    {
                        id: 'ytd_spending',
                        label: 'YTD Spending',
                        value: 2100000,
                        format: 'currency',
                        trend: 'up',
                        trendValue: 5.2,
                        description: '42% of annual budget'
                    },
                    {
                        id: 'budget_utilization',
                        label: 'Budget Utilization',
                        value: 42,
                        format: 'percentage',
                        trend: 'stable',
                        description: 'On track for fiscal year'
                    },
                    {
                        id: 'pending_approvals',
                        label: 'Pending Approvals',
                        value: 12,
                        format: 'number',
                        urgent: true,
                        description: 'Requires attention'
                    }
                ],
                divisionSummary: [
                    {
                        division: 'US',
                        name: 'Upper School',
                        allocated: 2000000,
                        spent: 840000,
                        encumbered: 160000,
                        available: 1000000,
                        utilization: 42
                    },
                    {
                        division: 'LS',
                        name: 'Lower School',
                        allocated: 1800000,
                        spent: 756000,
                        encumbered: 144000,
                        available: 900000,
                        utilization: 42
                    },
                    {
                        division: 'KK',
                        name: 'Keswick Kids',
                        allocated: 800000,
                        spent: 336000,
                        encumbered: 64000,
                        available: 400000,
                        utilization: 42
                    },
                    {
                        division: 'AD',
                        name: 'Administration',
                        allocated: 400000,
                        spent: 168000,
                        encumbered: 32000,
                        available: 200000,
                        utilization: 42
                    }
                ],
                transactions: generateDemoTransactions(20),
                alerts: [
                    {
                        type: 'warning',
                        message: 'Science department at 85% budget utilization',
                        timestamp: new Date()
                    }
                ],
                tacSummary: {
                    totalCollected: 850000,
                    totalAllocated: 800000,
                    totalSpent: 340000,
                    totalAvailable: 460000,
                    byCategory: {
                        technology: { allocated: 440000, spent: 187000 },
                        activities: { allocated: 200000, spent: 85000 },
                        consumables: { allocated: 160000, spent: 68000 }
                    }
                },
                trends: {
                    monthly: [
                        { month: 'Aug', budget: 416667, actual: 380000 },
                        { month: 'Sep', budget: 416667, actual: 420000 },
                        { month: 'Oct', budget: 416667, actual: 395000 },
                        { month: 'Nov', budget: 416667, actual: 410000 },
                        { month: 'Dec', budget: 416667, actual: 380000 },
                        { month: 'Jan', budget: 416667, actual: 415000 }
                    ],
                    categorical: [
                        { category: 'Technology', amount: 450000, percentage: 21.4 },
                        { category: 'Curriculum', amount: 380000, percentage: 18.1 },
                        { category: 'Supplies', amount: 320000, percentage: 15.2 },
                        { category: 'Prof. Dev.', amount: 280000, percentage: 13.3 },
                        { category: 'Facilities', amount: 240000, percentage: 11.4 },
                        { category: 'Activities', amount: 220000, percentage: 10.5 },
                        { category: 'Other', amount: 210000, percentage: 10.0 }
                    ]
                },
                financialHealth: {
                    status: 'healthy',
                    metrics: {
                        cashFlow: 'positive',
                        burnRate: 'normal',
                        runway: '8 months',
                        risk: 'low'
                    }
                }
            };
        }
        
        function generateDemoTransactions(count) {
            const vendors = ['Amazon', 'Staples', 'Apple', 'Best Buy', 'Office Depot'];
            const statuses = ['Approved', 'Pending', 'Processing'];
            const divisions = ['US', 'LS', 'KK', 'AD'];
            const departments = ['Math', 'Science', 'English', 'Elementary', 'Administration'];
            
            return Array.from({ length: count }, (_, i) => ({
                transactionId: `TRX-2024-${(1000 + i).toString().padStart(4, '0')}`,
                date: new Date(Date.now() - Math.random() * 30 * 24 * 60 * 60 * 1000),
                division: divisions[Math.floor(Math.random() * divisions.length)],
                department: departments[Math.floor(Math.random() * departments.length)],
                vendor: vendors[Math.floor(Math.random() * vendors.length)],
                description: `Purchase Order ${i + 1}`,
                amount: Math.round(Math.random() * 5000 + 100),
                status: statuses[Math.floor(Math.random() * statuses.length)]
            }));
        }
    </script>
</body>
</html>